---
title: "Jobs analysis MENA"
output:
  pdf_document: default
  html_notebook: default
---

```{r setup, include=FALSE}
#Define relative path
knitr::opts_knit$set(root.dir = "/Users/eves/Dropbox/MENA/Data/")
```

#Load libraries
```{r}
library(BAMMtools)
library(BBmisc)
library(classInt)
library(cowplot)
library(data.table)
library(doBy)
library(foreign)
library(ggplot2)
library(mapproj)
library(maptools)
library(plyr)
library(dplyr)
#library(raster)
#library(rgeos)
library(RColorBrewer)
library(rgdal)
library(shapefiles)
library(sp)
library(stringr)
library(tidyr)
library(tidyverse)
library(viridis)
library(viridisLite)
library(openxlsx)
```

#Set directories 
```{r}
dir_in<- "./Jobs/"
dir_out<-"./Jobs/Output/"
dir_out_country <-"./Jobs/Output/Country/"

getwd()
```

#Read excel

```{r}

mena_type <- read.xlsx(paste0(dir_in, "1a_employmentByType.xlsx"),
                      sheet = 1,
                      startRow = 1, colNames = TRUE, rowNames = FALSE, detectDates = FALSE,
                      skipEmptyRows = TRUE, skipEmptyCols = TRUE, rows = NULL, cols = NULL,
                      check.names = FALSE, namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE) %>% as.data.frame()

#Gross output multiplier
mena_gross <- read.xlsx(paste0(dir_in, "1a_outputBySector.xlsx"),
                      sheet = 1,
                      startRow = 1, colNames = TRUE, rowNames = FALSE, detectDates = FALSE,
                      skipEmptyRows = TRUE, skipEmptyCols = TRUE, rows = NULL, cols = NULL,
                      check.names = FALSE, namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE) %>% as.data.frame() 

#Value added multiplier
mena_value <- read.xlsx(paste0(dir_in, "1a_valueAddedBySector.xlsx"),
                      sheet = 1,
                      startRow = 1, colNames = TRUE, rowNames = FALSE, detectDates = FALSE,
                      skipEmptyRows = TRUE, skipEmptyCols = TRUE, rows = NULL, cols = NULL,
                      check.names = FALSE, namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE) %>% as.data.frame() 

#Irak, Lebanon and Syria
ils_type <- read.xlsx(paste0(dir_in, "1b_employmentByType.xlsx"),
                      sheet = 1,
                      startRow = 1, colNames = TRUE, rowNames = FALSE, detectDates = FALSE,
                      skipEmptyRows = TRUE, skipEmptyCols = TRUE, rows = NULL, cols = NULL,
                      check.names = FALSE, namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE) %>% as.data.frame()

ils_gross <- read.xlsx(paste0(dir_in, "1b_outputBySector.xlsx"),
                      sheet = 1,
                      startRow = 1, colNames = TRUE, rowNames = FALSE, detectDates = FALSE,
                      skipEmptyRows = TRUE, skipEmptyCols = TRUE, rows = NULL, cols = NULL,
                      check.names = FALSE, namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE) %>% as.data.frame() 

ils_value <- read.xlsx(paste0(dir_in, "1b_valueAddedBySector.xlsx"),
                      sheet = 1,
                      startRow = 1, colNames = TRUE, rowNames = FALSE, detectDates = FALSE,
                      skipEmptyRows = TRUE, skipEmptyCols = TRUE, rows = NULL, cols = NULL,
                      check.names = FALSE, namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE) %>% as.data.frame() 

#Other
world_type <- read.xlsx(paste0(dir_in, "2_employmentByType.xlsx"),
                      sheet = 1,
                      startRow = 1, colNames = TRUE, rowNames = FALSE, detectDates = FALSE,
                      skipEmptyRows = TRUE, skipEmptyCols = TRUE, rows = NULL, cols = NULL,
                      check.names = FALSE, namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE) %>% as.data.frame()

world_gross <- read.xlsx(paste0(dir_in, "2_outputBySector.xlsx"),
                      sheet = 1,
                      startRow = 1, colNames = TRUE, rowNames = FALSE, detectDates = FALSE,
                      skipEmptyRows = TRUE, skipEmptyCols = TRUE, rows = NULL, cols = NULL,
                      check.names = FALSE, namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE) %>% as.data.frame() 

world_value <- read.xlsx(paste0(dir_in, "2_valueAddedBySector.xlsx"),
                      sheet = 1,
                      startRow = 1, colNames = TRUE, rowNames = FALSE, detectDates = FALSE,
                      skipEmptyRows = TRUE, skipEmptyCols = TRUE, rows = NULL, cols = NULL,
                      check.names = FALSE, namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE) %>% as.data.frame() 

sec_shares <- read.xlsx(paste0(dir_in, "sectoral_shares.xlsx"),
                      sheet = 1,
                      startRow = 1, colNames = TRUE, rowNames = FALSE, detectDates = FALSE,
                      skipEmptyRows = TRUE, skipEmptyCols = TRUE, rows = NULL, cols = NULL,
                      check.names = FALSE, namedRegion = NULL, na.strings = "NA", fillMergedCells = FALSE) %>% as.data.frame() 

```


#World
```{r}
#Merge Turkey
turk_type<-mena_type %>%
  filter(reg == "tur")

turk_gross<-mena_gross %>%
  filter(reg == "tur")

turk_value<-mena_value %>%
  filter(reg == "tur")

#Add Turkey
world_type<-rbind(world_type, turk_type)
world_gross<-rbind(world_gross, turk_gross)
world_value<-rbind(world_value, turk_value)

turk_type <-NULL
turk_gross<-NULL
turk_value<-NULL

world_type$ISO<-toupper(world_type$reg)
world_gross$ISO<-toupper(world_gross$reg)
world_value$ISO<-toupper(world_value$reg)

world_type$ISO[world_type$ISO=="INDIA"] <- "IND"
world_gross$ISO[world_gross$ISO=="INDIA"] <- "IND"
world_value$ISO[world_value$ISO=="INDIA"] <- "IND"

#Divide by world regions 

EAP<-c("BRN", "CHN", "IDN", "LAO", "KHM", "MNG", "MYS", "NAM", "PHL", "SGP",  "THA", "VNM")

ECA<-c("ALB", "ARM", "AZE", "GEO", "GRC", "HUN", "KAZ", "KGZ", "RUS",  "SLV", "TJK", "UKR", "BLR", "TUR", "MLT")

LAC<-c("ARG", "BOL", "BRA", "CHL", "COL",  "CRI", "DOM", "ECU", "GTM", "HND", "JAM", "MEX", "NIC", "PER", "PRY", "URY", "VEN", "PAN", "PRI", "TTO")

SA<- c("BGD",  "IND", "LKA", "NPL", "PAK") 

SUBAF<- c("BEN", "BFA", "BWA", "CIV", "CMR", "ETH", "GHA", "GIN", "KEN", "MDG", "MOZ", "MUS", "MWI", "NGA", "RWA", "SEN", "TGO", "UGA",  "ZMB", "ZWE", "ZAF", "TZA") 

UMIE<-c("alb", "arg", "arm", "aze", "blr", "bwa", "bra", "chn", "col", "cri", "dom", "ecu", "geo", "gtm", "idn", "irn", "jam", "jor", "kaz", "mys", "mex", "pry","per", "rud", "zaf", "tha", "tur",  "ven")

 
world_type <- world_type %>% 
  mutate(reg2 = ifelse(ISO %in% EAP , "East Asia and Pacific",
          ifelse(ISO %in% ECA , "Europe and Central Asia",
         ifelse(ISO %in% LAC , "Latin America and the Caribbean",
         ifelse(ISO %in% SA , "South Asia",
        ifelse(ISO %in% SUBAF , "Sub-Saharan Africa", "NONE"))))))


world_gross <- world_gross %>% 
  mutate(reg2 = ifelse(ISO %in% EAP , "East Asia and Pacific",
          ifelse(ISO %in% ECA , "Europe and Central Asia",
         ifelse(ISO %in% LAC , "Latin America and the Caribbean",
         ifelse(ISO %in% SA , "South Asia",
        ifelse(ISO %in% SUBAF , "Sub-Saharan Africa", "NONE"))))))

world_value <- world_value %>% 
  mutate(reg2 = ifelse(ISO %in% EAP , "East Asia and Pacific",
          ifelse(ISO %in% ECA , "Europe and Central Asia",
         ifelse(ISO %in% LAC , "Latin America and the Caribbean",
         ifelse(ISO %in% SA , "South Asia",
        ifelse(ISO %in% SUBAF , "Sub-Saharan Africa", "NONE"))))))

 
```

#MENA/SECTOR LIST
```{r}
#MENA TOTAL
MENA<-c("are", "egy", "irn", "jor", "kwt", "omn", "qat", "sau", "tun", "mar", "Lebanon", "Iraq", "Syria")

#MENA standard
MENA_red<-c("are", "egy", "irn", "jor", "kwt", "omn", "qat", "sau", "tun", "mar")


#Sector List
#unique(mena_gross$ind)
#unique(ils_gross$ind)
sd_sec<-c("Fishing","Food", "Forestry","GrainsCrops","Lvstk", "Water")
#sd_related<-c("Wood", "Cons", "Paper", "Acomm", "Dwellings")
```


mena_tot = reduced mena
mena_total =MENA with "Lebanon", "Iraq", "Syria"
#Get total direct and indirect MENA COMPLETE
```{r}

#MENA JOBS
mena_tot<-mena_type%>%
  group_by(reg, invested, variable)%>%
  summarise(sum(value))
colnames(mena_tot)[colnames(mena_tot)=="sum(value)"] <- "total_jobs"

#ILS JOBS
ils_total<-ils_type%>%
  group_by(reg, invested, variable)%>%
  summarise(sum(value))
colnames(ils_total)[colnames(ils_total)=="sum(value)"] <- "total_jobs"

#MENA JOB TOTAL = Merge ils + MENA tot 
mena_total<-rbind(mena_tot, ils_total)


#Gross total
mena_Tgross<-mena_gross%>%
  group_by(reg, invested)%>%
  summarise(sum(value))
colnames(mena_Tgross)[colnames(mena_Tgross)=="sum(value)"] <- "total_gross"

ils_Tgross<-ils_gross%>%
  group_by(reg, invested)%>%
  summarise(sum(value))
colnames(ils_Tgross)[colnames(ils_Tgross)=="sum(value)"] <- "total_gross"

##MENA GROSS TOTAL
mena_TTgross<-rbind(mena_Tgross, ils_Tgross)

#Value total
mena_Tvalue<-mena_value%>%
  group_by(reg, invested)%>%
  summarise(sum(value))
colnames(mena_Tvalue)[colnames(mena_Tvalue)=="sum(value)"] <- "total_value"

ils_Tvalue<-ils_value%>%
  group_by(reg, invested)%>%
  summarise(sum(value))
colnames(ils_Tvalue)[colnames(ils_Tvalue)=="sum(value)"] <- "total_value"

#Merge
mena_TTvalue<-rbind(mena_Tvalue, ils_Tvalue)

#Merge gross and value MENA complete
mena_total<-left_join(mena_total, mena_TTgross, by=c("reg","invested"))
mena_total<-left_join(mena_total, mena_TTvalue, by=c("reg","invested"))


#Remove no mena countries and regions
mena_total<-mena_total%>%
  filter(reg !="tur" )%>%
  filter(reg !="row")%>%
  filter(reg !="xws")%>%
  filter(reg !="isr")
  unique(mena_total$reg)

  
#MENA REGION AGGREGATE

#Sectoral shares
  
colnames(sec_shares)[colnames(sec_shares)=="ind"] <- "invested"
mena_total<-left_join(mena_total, sec_shares, by = c("reg", "invested"))
mena_total$size<- NULL

  
#JOBS  
colnames(mena_total)

mena_total<-mena_total%>%
  group_by(invested, variable)%>%
    mutate(mean_jobs= mean(total_jobs,na.rm = T), 
           mean_gross= mean(total_gross, na.rm=T), 
           mean_value=mean(total_value, na.rm = T),       
           mean_output_shr=mean(output_shr, na.rm = T),  
           mean_value_shr=mean(valueAdded_shr, na.rm = T),
           mean_labor_shr=mean(labor_shr, na.rm = T))

write.csv(mena_total, paste0(dir_out, "MENA_total.csv"))

mena_aggre<-mena_total%>%
  group_by(invested, variable)%>%
    summarise(mean_jobs= mean(total_jobs,na.rm = T),
              mean_gross= mean(total_gross, na.rm=T),
              mean_value=mean(total_value, na.rm = T),
              mean_output_shr=mean(output_shr, na.rm = T),  
              mean_value_shr=mean(valueAdded_shr, na.rm = T),
              mean_labor_shr=mean(labor_shr, na.rm = T)
              )

#Create sector variable
#mena_aggre = mena_aggre %>% mutate(sector=ifelse(invested %in% sd_sec,"SD Sector", 
#                                                 ifelse(invested %in% sd_related, "SD Related", "No SD Sector")))
                                                 
#write.csv(mena_aggre, paste0(dir_out, "MENA_aggre.csv"))


#MENA reduce

mena_total_red<-mena_total%>%
  filter(reg %in% MENA_red)%>%
  group_by(invested, variable)%>%
    mutate(mean_jobs= mean(total_jobs,na.rm = T), 
           mean_gross= mean(total_gross, na.rm=T), 
           mean_value=mean(total_value, na.rm = T),       
           mean_output_shr=mean(output_shr, na.rm = T),  
           mean_value_shr=mean(valueAdded_shr, na.rm = T),
           mean_labor_shr=mean(labor_shr, na.rm = T))

#write.csv(mena_total_red, paste0(dir_out, "MENA_red_total.csv"))

unique(mena_total_red$reg)


mena_red_aggre<-mena_total%>%
  filter(reg %in% MENA_red)%>%
  group_by(invested, variable)%>%
    summarise(mean_jobs= mean(total_jobs,na.rm = T),
              mean_gross= mean(total_gross, na.rm=T),
              mean_value=mean(total_value, na.rm = T),
              mean_output_shr=mean(output_shr, na.rm = T),  
              mean_value_shr=mean(valueAdded_shr, na.rm = T),
              mean_labor_shr=mean(labor_shr, na.rm = T)
              )

#write.csv(mena_red_aggre, paste0(dir_out, "MENA_red_aggre.csv"))

#remove things we dont need
ils_Tgross <-NULL
ils_Tvalue <-NULL
mena_Tgross <-NULL
mena_Tvalue <-NULL
mena_TTvalue <-NULL
mena_TTgross <- NULL
```
#COMPLETE
#mena_total - country total employment and mean of mena complete 
#mena_aggre - mean of mena complete

#REDUCED
#mena_total_red - country total employment and mean of mena reduced
#mena_red_aggre -  mean of mena  reduced 


#MENA Weighted mean
```{r}
library(WDI)

GDP<- WDI(country = c("ARE", "EGY", "IRN", "JOR", "KWT", "OMN", "QAT", "SAU", "TUN", "MAR", "LBN", "IRQ", "SYR"), indicator = "NY.GDP.MKTP.CD", start = 1990, end = 2020, extra = TRUE, cache = NULL)
GDP <- na.omit(GDP)
GDP <- GDP %>% group_by(iso2c) %>%
  filter(year==max(year))
GDP <- subset(GDP, select = -c(iso2c,year,capital,longitude,latitude,lending, region, income, country))

#Colnames
colnames(GDP)[colnames(GDP)=="iso3c"] <- "reg"
GDP$reg<-tolower(GDP$reg)
colnames(GDP)[colnames(GDP)=="NY.GDP.MKTP.CD"] <- "GDP"
GDP$reg[GDP$reg=="irq"] <- "Iraq"
GDP$reg[GDP$reg=="syr"] <- "Syria"
GDP$reg[GDP$reg=="lbn"] <- "Lebanon"


#Merge GDP
mena_total_raw<-mena_total[,1:9]
mena_total_raw<-left_join(mena_total_raw, GDP, by="reg")


#MENA weighted reduce
mena_w_total_red<-mena_total_raw%>%
  filter(reg %in% MENA_red)%>%
  group_by(invested, variable)%>%
    mutate(wmean_jobs= weighted.mean(total_jobs, GDP, na.rm = T),
              wmean_gross= weighted.mean(total_gross, GDP, na.rm=T),
              wmean_value=weighted.mean(total_value,GDP,  na.rm = T),
              wmean_output_shr=weighted.mean(output_shr, GDP, na.rm = T),  
              wmean_value_shr=weighted.mean(valueAdded_shr, GDP,  na.rm = T),
              wmean_labor_shr=weighted.mean(labor_shr, GDP,  na.rm = T)
              )

#write.csv(mena_w_total_red, paste0(dir_out, "MENA_w_red_total.csv"))

mena_w_red_aggre<-mena_total_raw%>%
  filter(reg %in% MENA_red)%>%
  group_by(invested, variable)%>%
    summarise(wmean_jobs= weighted.mean(total_jobs, GDP, na.rm = T),
              wmean_gross= weighted.mean(total_gross, GDP, na.rm=T),
              wmean_value=weighted.mean(total_value,GDP,  na.rm = T),
              wmean_output_shr=weighted.mean(output_shr, GDP, na.rm = T),  
              wmean_value_shr=weighted.mean(valueAdded_shr, GDP,  na.rm = T),
              wmean_labor_shr=weighted.mean(labor_shr, GDP,  na.rm = T)
              )

#write.csv(mena_w_red_aggre, paste0(dir_out, "MENA_w_red_aggre.csv"))

```


#Other regions
```{r}
#Total per country
region_type<-world_type%>%
  group_by(invested, variable, reg, reg2)%>%
  summarise(sum(value))
colnames(region_type)[colnames(region_type)=="sum(value)"] <- "total_jobs"

region_gross<-world_gross%>%
  group_by(invested, reg, reg2)%>%
  summarise(sum(value))
colnames(region_gross)[colnames(region_gross)=="sum(value)"] <- "total_gross"

region_value<-world_value%>%
  group_by(invested, reg, reg2)%>%
  summarise(sum(value))
colnames(region_value)[colnames(region_value)=="sum(value)"] <- "total_value"

region_total<-left_join(region_type, region_gross, by=c("reg2", "reg", "invested"))
region_total<-left_join(region_total, region_value, by=c("reg2", "reg", "invested"))

#Save to use later
region_total_m<-region_total

#MEAN BY REGION
region_total<-region_total%>%
  group_by(reg2, invested, variable)%>%
    summarise(mean_jobs= mean(total_jobs,na.rm = T), mean_gross= mean(total_gross, na.rm=T), mean_value=mean(total_value, na.rm = T))


#Renove data we dont use
region_type <-NULL
region_gross <-NULL
region_value<-NULL
world_type<-NULL
world_gross<-NULL
world_value<-NULL
```

#BIND MENA AND OTHER REGIONS
```{r}
mena_total_red_m<-mena_total_red

mena_total_red_m$reg2<-"MENA"

mena_total_red_m<-mena_total_red_m%>%
select("invested", "variable", "reg", "reg2", "total_jobs", "total_gross", "total_value")

world_mena<-rbind(mena_total_red_m, region_total_m)

world_mena = world_mena %>% mutate(reg3=ifelse(reg %in%  UMIE,"UMIE", "NO"))
write.csv(world_mena, paste0(dir_out, "MENA_red_UMIE.csv"))

world_UMIE_aggre<-world_mena%>%
  filter(reg3=="UMIE")%>%
  filter(variable == "total")%>%
  group_by(invested, variable)%>%
    summarise(umie_jobs= mean(total_jobs,na.rm = T), umie_gross= mean(total_gross, na.rm=T), umie_value=mean(total_value, na.rm = T))
```

#Themes for graphs
```{r}
theme_graph <- function(...) {
  theme(
    axis.text.x = element_text(size = 7, hjust = 1, vjust = 0.5),
    legend.text=element_text(size=8),
    legend.title = element_text(size=9),
    axis.text.y = element_text(size = 5),
    axis.title.x= element_text(size = 10),
    legend.position="right",
    plot.subtitle=element_text(hjust=0.5, size = 9),
    plot.title=element_text(hjust=0.5, face = "bold"),
    axis.title.y = element_text(size = 9),
    plot.caption=element_text(size=8),
    ...
  )
}

#Vertical names in x
theme_graph1 <- function(...) {
  theme(
    axis.text.x = element_text(size = 7, angle = 90, hjust = 1, vjust = 0.5),
    legend.text=element_text(size=9),
    axis.text.y = element_text(size = 5),
    axis.title.x= element_text(size = 10),
    plot.subtitle=element_text(hjust=0.5, size = 9),
    plot.title=element_text(hjust=0.5, face = "bold"),
    axis.title.y = element_text(size = 9),
    plot.caption=element_text(size=8),
    ...
  )
}
```


#Graph Total value - total jobs
```{r}
#Total MENA

mean(mena_aggre$mean_gross)

mena_aggre%>% 
  filter(variable== "total")%>%
ggplot(aes(x =mean_gross*10, y =mean_jobs*10)) +
  geom_point(aes(size = mean_output_shr), color = "purple4", alpha=0.7)+
  geom_hline(aes(yintercept = mean(mean_jobs*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_vline(aes(xintercept = mean(mean_gross*10)), linetype="dashed", 
                color = "grey25", size=.5)+
    scale_color_viridis(discrete=TRUE) +
    theme_grey() +
  theme_graph()+
  labs(
  size= "Gross Output \n Share (%)",
  x = "Gross Output Multiplier",
  y = "Total Jobs (direct + indirect)",
  title = "MENA: Total Job and Gross Output Multiplier",
  subtitle= "By 10 million USD invested in each sector")+
  geom_text_repel(aes(label=invested), hjust=.9, vjust= .25, size=3)
ggsave(paste(dir_out, "MENA_jobs_gross_all.png"), height=6, width = 8, units = c("in"))


#MENA Reduced 
mena_red_aggre%>% 
  filter(variable== "total")%>%
ggplot(aes(x =mean_gross*10, y =mean_jobs*10)) +
   geom_point(aes(size = mean_output_shr), color = "purple4", alpha=0.7)+
  geom_hline(aes(yintercept = mean(mean_jobs*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_vline(aes(xintercept = mean(mean_gross*10)), linetype="dashed", 
                color = "grey25", size=.5)+
    scale_color_viridis(discrete=TRUE) +
    theme_grey() +
  theme_graph()+
  labs(
  size= "Gross Output \n Share (%)",
  x = "Gross Output",
  y = "Total Jobs (direct + indirect)",
  title = "MENA: Total Job and Gross Output Multiplier",
  subtitle= "By 10 million USD invested in each sector",
  caption = "MENA region excluding Iraq, Lebanon and Syria, due to a different \n sectoral agreggation in Other Services and Public Administration.")+
  geom_text_repel(aes(label=invested), hjust=.9, vjust= .25, size=3)
ggsave(paste(dir_out, "MENA_jobs_gross_redu.png"), height=6, width = 8, units = c("in"))


#Mena WEIGHTED
mena_w_red_aggre%>% 
  filter(variable== "total")%>%
ggplot(aes(x =wmean_gross*10, y =wmean_jobs*10)) +
   geom_point(aes(size = wmean_output_shr), color = "purple4", alpha=0.7)+
  geom_hline(aes(yintercept = mean(wmean_jobs*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_vline(aes(xintercept = mean(wmean_gross*10)), linetype="dashed", 
                color = "grey25", size=.5)+
    scale_color_viridis(discrete=TRUE) +
    theme_grey() +
  theme_graph()+
  labs(
  size= "Gross Output \n Share (%)",
  x = "Gross Output",
  y = "Total Jobs (direct + indirect)",
  title = "MENA: Total Job and Gross Output Multiplier",
  subtitle= "By 10 million USD invested in each sector",
  caption = "Weighted mean by GDP. MENA region excluding Iraq, Lebanon and Syria, due to a \n different  sectoral agreggation in Other Services and Public Administration.")+
  geom_text_repel(aes(label=invested), hjust=.9, vjust= .25, size=3)
ggsave(paste(dir_out, "WMENA_jobs_gross_redu.png"), height=6, width = 8, units = c("in"))
```

#Value - total jobs
```{r}
#Total MENA
mena_aggre%>% 
  filter(variable== "total")%>%
ggplot(aes(x =mean_value*10, y =mean_jobs*10)) +
   geom_point(aes(size = mean_value_shr), color = "springgreen3", alpha=0.7)+
  geom_hline(aes(yintercept = mean(mean_jobs*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_vline(aes(xintercept = mean(mean_value*10)), linetype="dashed", 
                color = "grey25", size=.5)+
    scale_color_viridis(discrete=TRUE) +
    theme_grey() +
theme_graph()+
  labs(
  size= "Value added (%)",
  x = "Value added (income) Multiplier",
  y = "Total Jobs (direct + indirect)",
  title = "MENA: Total Job and Value Added (income) Multiplier",
  subtitle= "By 10 million USD invested in each sector"
  )+
  geom_text_repel(aes(label=invested), hjust=.9, vjust= .25, size=3)
ggsave(paste(dir_out, "MENA_jobs_value_all.png"), height=6, width = 8, units = c("in"))


#Reduced MENA
mena_red_aggre%>% 
  filter(variable== "total")%>%
ggplot(aes(x =mean_value*10, y =mean_jobs*10)) +
  geom_point(aes(size = mean_value_shr), color = "springgreen3", alpha=0.7)+
  geom_hline(aes(yintercept = mean(mean_jobs*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_vline(aes(xintercept = mean(mean_value*10)), linetype="dashed", 
                color = "grey25", size=.5)+
    scale_color_viridis(discrete=TRUE) +
    theme_grey() +
  theme_graph()+
  labs(
  size= "Value added (%)",
  x = "Value added (income)",
  y = "Total Jobs (direct + indirect)",
  title = "MENA: Total Job and Value Added (income) Multiplier",
  subtitle= "By 10 million USD invested in each sector",
  caption = "MENA region excluding Iraq, Lebanon and Syria, due to a different \n sectoral agreggation in Other Services and Public Administration." )+
  geom_text_repel(aes(label=invested), hjust=.9, vjust= .25, size=3)
ggsave(paste(dir_out, "MENA_jobs_value_red.png"), height=6, width = 8, units = c("in"))



#Reduced WEIGHTED MENA
mena_w_red_aggre%>% 
  filter(variable== "total")%>%
ggplot(aes(x =wmean_value*10, y =wmean_jobs*10)) +
  geom_point(aes(size = wmean_value_shr), color = "springgreen3", alpha=.5)+
  geom_hline(aes(yintercept = mean(wmean_jobs*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_vline(aes(xintercept = mean(wmean_value*10)), linetype="dashed", 
                color = "grey25", size=.5)+
    scale_color_viridis(discrete=TRUE) +
    theme_grey() +
  theme_graph()+
  labs(
  size= "Value added (%)",
  x = "Value added (income)",
  y = "Total Jobs (direct + indirect)",
  title = "MENA: Total Job and Value Added (income) Multiplier",
  subtitle= "By 10 million USD invested in each sector",
  caption = "Weighted mean by GDP. MENA region excluding Iraq, Lebanon and Syria,\n due to a different  sectoral agreggation in Other Services and Public Administration." )+
  geom_text_repel(aes(label=invested), hjust=.9, vjust= .25, size=3)
ggsave(paste(dir_out, "WMENA_jobs_value_red.png"), height=6, width = 8, units = c("in"))



#MENA RED - Line for UMIE
mena_red_aggre1<-left_join(mena_red_aggre, world_UMIE_aggre, by= c("invested", "variable"))
mena_red_aggre1%>% 
  filter(variable== "total")%>%
ggplot(aes(x =mean_value*10, y =mean_jobs*10)) +
  geom_point(aes(size = mean_value_shr), color = "springgreen3", alpha=1)+
  geom_hline(aes(yintercept = mean(mean_jobs*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_vline(aes(xintercept = mean(mean_value*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_hline(aes(yintercept = mean(umie_jobs*10)), linetype="dashed", 
                color = "deepskyblue3", size=.5)+
  geom_vline(aes(xintercept = mean(umie_value*10)), linetype="dashed", 
                color = "deepskyblue3", size=.5)+
    scale_color_viridis(discrete=TRUE) +
    theme_grey() +
  theme_graph()+
  labs(
  size= "Value added (%)",
  x = "Value added (income) Multiplier",
  y = "Total Jobs (direct + indirect)",
  title = "MENA: Total Job and Value Added (income) Multiplier",
  subtitle= "By 10 million USD invested in each sector",
  caption = "Note: Line in grey represents the mean for MENA  and line in blue the mean for Upper-Middle-Income countries. MENA region excluding \n Iraq, Lebanon and Syria, due to a different sectoral agreggation in Other Services and Public Administration." )+
  geom_text_repel(aes(label=invested), hjust=.9, vjust= .25, size=3)
ggsave(paste(dir_out, "MENA_jobs_value_means.png"), height=6, width = 8, units = c("in"))


```

```{r}

one<-mena_aggre%>%
filter(invested %in% sd_sec)%>%
  filter(variable== "total")

mean(one$mean_jobs)
#MEAN SD MENA TOTAL 12.3

one<-mena_red_aggre%>%
filter(invested %in% sd_sec)%>%
  filter(variable== "total")

mean(one$mean_jobs)
#MEAN SD MENA REDUCED 10.7


one<-mena_w_red_aggre%>%
filter(invested %in% sd_sec)%>%
  filter(variable== "total")

one<-mena_w_red_aggre%>%
#filter(invested %in% brown_sec)%>%
  filter(variable== "total")

mean(one$wmean_jobs)
# MEAN WEIGHTED SD MENA REDUCED 9.350934

```

#Type (direct/indirect) of Job Mena 
```{r}

mena_aggre$type_f = factor(mena_aggre$variable, levels = c("total", "direct", "indirect"))
mena_red_aggre$type_f = factor(mena_red_aggre$variable, levels = c("total", "direct", "indirect"))

#levels(mena_aggre$type_f)
#levels(mena_red_aggre$type_f) 

#MENA TOTAL
mena_aggre%>%
  filter(variable!="total")%>%
ggplot(aes(x = reorder(invested, - mean_jobs), y = mean_jobs*10)) + 
    geom_bar(aes(fill = type_f),stat = "identity",position = "stack")+
  labs(
  y = "Job Multiplier (# Jobs)",
  x = "",
  title = "MENA: Job multiplier",
  subtitle= "By 10 million USD invested in each sector")+
  theme_graph1(legend.position="right")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values = brewer.pal(2,"Set2"),
                    name="",
                    labels=c("Direct", "Indirect"))

ggsave(paste(dir_out, "MENA_jobs_type_all.png"), height=6, width = 8, units = c("in"))


mena_red_aggre%>%
    filter(variable!="total")%>%
ggplot(aes(x = reorder(invested, - mean_jobs), y = mean_jobs*10)) + 
    geom_bar(aes(fill = type_f),stat = "identity",position = "stack")+
  labs(
  y = "Job Multiplier (# Jobs)",
  x = "",
  title = "MENA: Job multiplier",
  subtitle= "By 10 million USD invested in each sector", 
  caption = "MENA region excluding Iraq, Lebanon and Syria, due to a different \n sectoral agreggation in Other Services and Public Administration." )+
  theme_graph1()+
  scale_fill_manual(values = brewer.pal(3,"Set2"),
                    name="",
                    labels=c("Direct", "Indirect"))
ggsave(paste(dir_out, "MENA_jobs_type_red.png"), height=6, width = 8, units = c("in"))


mena_w_red_aggre$type_f = factor(mena_w_red_aggre$variable, levels = c("total", "direct", "indirect"))
mena_w_red_aggre%>%
  filter(variable!="total")%>%
ggplot(aes(x = reorder(invested, - wmean_jobs), y = wmean_jobs*10)) + 
    geom_bar(aes(fill = type_f),stat = "identity",position = "stack")+
  labs(
  y = "Job Multiplier (# Jobs)",
  x = "",
  title = "MENA: Job multiplier",
  subtitle= "By 10 million USD invested in each sector", 
  caption = "Weighted mean by GDP. MENA region excluding Iraq, Lebanon and Syria, due \n to a different  sectoral agreggation in Other Services and Public Administration." )+
  theme_graph1()+
  scale_fill_manual(values = brewer.pal(3,"Set2"),
                    name="",
                    labels=c("Direct", "Indirect"))
ggsave(paste(dir_out, "WMENA_jobs_type_red.png"), height=6, width = 8, units = c("in"))



```

#Total employment for low skill workers
```{r}

mena_lowskills<-mena_type%>%
  filter(laborType == "clerks" |  laborType == "ag_othlowsk")%>%
  filter(reg %in% MENA_red)

mena_lowskills<-mena_lowskills%>%
  group_by(reg, invested, variable)%>%
    summarise(sum_low_jobs= sum(value, na.rm = T))

mena_lowskills<-mena_lowskills%>%
  group_by(invested, variable)%>%
    summarise(mean_low_jobs= mean(sum_low_jobs, na.rm = T))

mena_lowskills$type_f = factor(mena_lowskills$variable, levels = c("total", "direct", "indirect"))
```

#Type of Jobs LOW SKILLED (direct/indirect) Jobs Mena 
```{r}
mena_lowskills%>%
   filter(variable!="total")%>%
ggplot(aes(reorder(invested, - mean_low_jobs), y = mean_low_jobs*10)) + 
    geom_bar(aes(fill = type_f),stat = "identity",position = "stack")+
  labs(
  y = "Job Multiplier (# low skilled jobs)",
  x = "",
  title = "MENA: Job multiplier for low skilled jobs",
  subtitle= "By 10 million USD invested in each sector", 
  caption = "Notes:Low skilled jobs are agricultural, unskilled labors and clerk jobs. Aggregate data excluding Iraq,\n Lebanon and Syria, due to a different  sectoral agreggation in Other Services and Public Administration.")+
  theme_graph1(legend.position="right")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values = brewer.pal(3,"Dark2"),
                    name="",
                    labels=c("Direct", "Indirect"))

ggsave(paste(dir_out, "MENA_jobs_low_red.png"), height=6, width = 8, units = c("in"))
```
#Low skills weighted
```{r}
mena_lowskills<-mena_type%>%
  filter(laborType == "clerks" |  laborType == "ag_othlowsk")%>%
  filter(reg %in% MENA_red)


mena_lowskills<-mena_lowskills%>%
  group_by(reg, invested, variable)%>%
    summarise(sum_low_jobs= sum(value, na.rm = T))


mena_w_lowskills<-left_join(mena_lowskills, GDP, by="reg")

mena_w_lowskills<-mena_w_lowskills%>%
  group_by(invested, variable)%>%
    summarise(wmean_low_jobs= weighted.mean(sum_low_jobs, GDP))

mena_w_lowskills$type_f = factor(mena_w_lowskills$variable, levels = c("total", "direct", "indirect"))



mena_w_lowskills%>%
   filter(variable!="total")%>%
ggplot(aes(reorder(invested, - wmean_low_jobs), y = wmean_low_jobs*10)) + 
    geom_bar(aes(fill = type_f),stat = "identity",position = "stack")+
  labs(
  y = "Job Multiplier (# low skilled jobs)",
  x = "",
  title = "MENA: Job multiplier for low skilled jobs",
  subtitle= "By 10 million USD invested in each sector", 
  caption = "Notes:Low skilled jobs are agricultural, unskilled labors and clerk jobs. \n Weighted mean by GDP. MENA region excluding Iraq, Lebanon and Syria,\n due to a different  sectoral agreggation in Other Services and Public Administration.")+
  theme_graph1(legend.position="right")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values = brewer.pal(3,"Dark2"),
                    name="",
                    labels=c("Direct", "Indirect"))

ggsave(paste(dir_out, "WMENA_jobs_low_red.png"), height=6, width = 8, units = c("in"))


```






















#Total Jobs compare  (no used)
```{r}
#MENA Total
mena_reduce<-mena_aggre%>%
  filter(variable == "total")%>%
  mutate(reg2 = "MENA")%>%
  select(reg2, invested, variable,  mean_jobs, mean_gross, mean_value)

region_reduce<-region_total%>%
  filter(variable == "total")

complete_regions<-rbind(region_reduce, mena_reduce)

 
complete_regions$region_f = factor(complete_regions$reg2, levels = c("MENA", "East Asia and Pacific", "Europe and Central Asia", "Latin America and the Caribbean",  "South Asia",  "Sub-Saharan Africa"))
                                                          

#JOBS
complete_regions %>%
  filter(reg2 != "NONE")%>%
ggplot(aes(x = reorder(invested, -mean_jobs), y =mean_jobs*10, group= reg2, colour=region_f)) +
  geom_line(aes(linetype=region_f), size=1)+
  #geom_line(size=1)+
  geom_point()+
  theme_grey()+
    labs(
  x = "",
  y = "Total Jobs (direct + indirect)",
  title = "Total Job multiplier",
  subtitle= "By 10 million USD invested in each sector")+
    theme(axis.text.x = element_text(size = 7, angle = 90, hjust = 1, vjust = 0.5), legend.text=element_text(size=9), axis.text.y = element_text(size = 5), axis.title.x= element_text(size = 10, hjust=0.5), legend.position="bottom", plot.subtitle=element_text(hjust=0.5, size = 9), plot.title=element_text(hjust=0.5, size = 12), axis.title.y = element_text(size = 9), plot.caption=element_text(size=8), legend.title=element_blank())+
  scale_colour_manual(values = brewer.pal(7,"Set1"))
  #ylim(0, 120)
        
ggsave(paste(dir_out, "RegionsWB_jobs_type_all.png"), height=6, width = 8, units = c("in"))

############   MENA Reduced  ###########
mena_red_reduce<-mena_red_aggre%>%
  filter(variable == "total")%>%
  mutate(reg2 = "MENA")%>%
  select(reg2, invested, variable,  mean_jobs, mean_gross, mean_value)

complete_red_regions<-rbind(region_reduce, mena_red_reduce)

 
complete_red_regions$region_f = factor(complete_red_regions$reg2, levels = c("MENA", "East Asia and Pacific", "Europe and Central Asia", "Latin America and the Caribbean",  "South Asia",  "Sub-Saharan Africa"))


complete_red_regions %>%
  filter(reg2 != "NONE")%>%
ggplot(aes(x = reorder(invested, -mean_jobs), y =mean_jobs*10, group= reg2, colour=region_f)) +
  geom_line(aes(linetype=region_f), size=1)+
  #geom_line(size=1)+
  geom_point()+
  theme_grey()+
    labs(
  x = "",
  y = "Total Jobs (direct + indirect)",
  title = "Total Job multiplier",
  subtitle= "By 10 million USD invested in each sector",
  caption = "MENA region excluding Iraq, Lebanon and Syria, due to a different \n sectoral agreggation in Other Services and Public Administration."
  )+
    theme(axis.text.x = element_text(size = 7, angle = 90, hjust = 1, vjust = 0.5), legend.text=element_text(size=9), axis.text.y = element_text(size = 5), axis.title.x= element_text(size = 10, hjust=0.5), legend.position="bottom", plot.subtitle=element_text(hjust=0.5, size = 9), plot.title=element_text(hjust=0.5, size = 12), axis.title.y = element_text(size = 9), plot.caption=element_text(size=8), legend.title=element_blank())+
  scale_colour_manual(values = brewer.pal(7,"Set1"))
  ggsave(paste(dir_out, "RegionsWB_jobs_type_red.png"), height=6, width = 8, units = c("in"))
 


```

#Total Gross Compare (no used)
```{r}

unique(complete_regions$reg2)

complete_regions %>%
 filter(reg2 != "NONE")%>%
ggplot( aes(x = reorder(invested, -mean_gross), y =mean_gross*10, group= reg2, colour=region_f)) +
  geom_line(aes(linetype=region_f), size=1)+
  #geom_line(size=1)+
  geom_point()+
  theme_dark()+
    labs(
  x = "",
  y = " Total Gross output multiplier",
  title = "Gross output  multiplier",
  subtitle= "By 10 million USD invested in each sector"
  #,
 # caption = "Other Service, Public Aministration, Education and Health sectors omitted,\n as these categories are not consistent for all the countries in the MENA region"
 )+
    theme(axis.text.x = element_text(size = 7, angle = 90, hjust = 1, vjust = 0.5), legend.text=element_text(size=9), axis.text.y = element_text(size = 5), axis.title.x= element_text(size = 10, hjust=0.5), legend.position="bottom", plot.subtitle=element_text(hjust=0.5, size = 9), plot.title=element_text(hjust=0.5, size = 12), axis.title.y = element_text(size = 9), plot.caption=element_text(size=8), legend.title=element_blank())+
  scale_colour_manual(values = brewer.pal(7,"Set1"))

ggsave(paste(dir_out, "RegionsWB_Gross_all.png"), height=6, width = 8, units = c("in"))



complete_red_regions %>%
 filter(reg2 != "NONE")%>%
ggplot( aes(x = reorder(invested, -mean_gross), y =mean_gross*10, group= reg2, colour=region_f)) +
  geom_line(aes(linetype=region_f), size=1)+
  #geom_line(size=1)+
  geom_point()+
  theme_dark()+
    labs(
  x = "",
  y = " Total Gross output multiplier",
  title = "Gross output multiplier",
  subtitle= "By 10 million USD invested in each sector",
  caption= "MENA region excluding Iraq, Lebanon and Syria, due to a different \n sectoral agreggation in Other Services and Public Administration.")+
    theme(axis.text.x = element_text(size = 7, angle = 90, hjust = 1, vjust = 0.5), legend.text=element_text(size=9), axis.text.y = element_text(size = 5), axis.title.x= element_text(size = 10, hjust=0.5), legend.position="bottom", plot.subtitle=element_text(hjust=0.5, size = 9), plot.title=element_text(hjust=0.5, size = 12), axis.title.y = element_text(size = 9), plot.caption=element_text(size=8), legend.title=element_blank())+
  scale_colour_manual(values = brewer.pal(7,"Set1"))

ggsave(paste(dir_out, "RegionsWB_Gross_red.png"), height=6, width = 8, units = c("in"))

```

#Total VA Compare (no used)
```{r}

complete_regions %>%
  filter(reg2 != "NONE")%>%
ggplot( aes(x = reorder(invested, -mean_value), y =mean_value*10, group= region_f, colour=region_f)) +
  geom_line(aes(linetype=region_f), size=1)+
  #geom_line(size=1)+
  geom_point()+
  theme_dark()+
    labs(
  x = "",
  y = "Value added (income)",
  title = "Value Added (income) Multiplier",
  subtitle= "By 10 million USD invested in each sector")+
    theme(axis.text.x = element_text(size = 7, angle = 90, hjust = 1, vjust = 0.5), legend.text=element_text(size=9), axis.text.y = element_text(size = 5), axis.title.x= element_text(size = 10, hjust=0.5), legend.position="bottom", plot.subtitle=element_text(hjust=0.5, size = 9), plot.title=element_text(hjust=0.5, size = 12), axis.title.y = element_text(size = 9), plot.caption=element_text(size=8), legend.title=element_blank())+
  scale_colour_manual(values = brewer.pal(7,"Set1"))
ggsave(paste(dir_out, "RegionsWB_value_all.png"), height=6, width = 8, units = c("in"))


####Reduced

complete_red_regions %>%
  filter(reg2 != "NONE")%>%
ggplot( aes(x = reorder(invested, -mean_value), y =mean_value*10, group= region_f, colour=region_f)) +
  geom_line(aes(linetype=region_f), size=1)+
  #geom_line(size=1)+
  geom_point()+
  theme_dark()+
    labs(
  x = "",
  y = "Value added (income)",
  title = "Value Added (income) Multiplier",
  subtitle= "By 10 million USD invested in each sector")+
    theme(axis.text.x = element_text(size = 7, angle = 90, hjust = 1, vjust = 0.5), legend.text=element_text(size=9), axis.text.y = element_text(size = 5), axis.title.x= element_text(size = 10, hjust=0.5), legend.position="bottom", plot.subtitle=element_text(hjust=0.5, size = 9), plot.title=element_text(hjust=0.5, size = 12), axis.title.y = element_text(size = 9), plot.caption=element_text(size=8), legend.title=element_blank())+
  scale_colour_manual(values = brewer.pal(7,"Set1"))
ggsave(paste(dir_out, "RegionsWB_value_red.png"), height=6, width = 8, units = c("in"))


#MENA4<-complete_regions %>%
 # filter(reg2 == "MENA")
```

#Types of Jobs ALL JOBS (MENA)
```{r}
mena_jobs<-mena_type%>%
  group_by(reg, invested, variable)%>%
  mutate(total_jobs= sum(value))%>%
  mutate(per_jobs= value*100/total_jobs)%>%
  filter(reg %in% MENA)
write.csv(mena_jobs, paste0(dir_out, "MENA_jobs_skills_red_percent.csv"))

mena_jobs$laborType_f <- factor(mena_jobs$laborType, levels = c("tech_aspros", "service_shop", "off_mgr_pros", "clerks", "ag_othlowsk"))
unique(mena_jobs$laborType)

exclu_countries<-c("tur", "row", "xws","isr")
  
#Mena jobs aggre
mena_jobs_aggre<-mena_jobs%>%
  filter(reg %nin% exclu_countries)%>%
  group_by(invested, variable, laborType)%>%
  summarise(mean_mena= mean(value))

mena_jobs_aggre$laborType_f <- factor(mena_jobs_aggre$laborType, levels = c("tech_aspros", "off_mgr_pros", "service_shop", "clerks", "ag_othlowsk"))
unique(mena_jobs$laborType)


#MENA (reduced)
mena_jobs_aggre%>%
filter(variable == 'total')%>%   
ggplot(aes(fill=laborType_f, y=mean_mena*10, x=reorder(invested, -mean_mena))) +
  geom_bar(position="stack", stat="identity")+
  labs(
  x = "",
  y = "Total job multiplier (Direct + Indirect)",
  title = "MENA: Job Multiplier by skill",
  subtitle= "By 10 million USD invested in each sector",
  caption = "MENA region excluding Iraq, Lebanon and Syria, due to a different \n sectoral agreggation in Other Services and Public Administration.")+
  theme_classic()+
  theme_graph1(legend.position= "bottom")+
  scale_fill_manual(values = brewer.pal(5,"Set2"),
                    name="",
                    labels=c("Tech/Professional", "Service/Shop Owner", "Offi/Manager", "Clerk", "Agri/Unskilled"))

ggsave(paste(dir_out, "Jobs_type_skill_red.png"), height=6, width = 8, units = c("in"))


#ALL MENA 
all_jobs<-rbind(mena_type, ils_type)

mena_jobs_complete<-all_jobs%>%
  group_by(reg, invested, variable)%>%
  mutate(total_jobs= sum(value))%>%
  mutate(per_jobs= value*100/total_jobs)%>%
  filter(reg %in% MENA)
write.csv( mena_jobs, paste0(dir_out, "MENA_jobs_skills_all.csv"))

mena_jobs_complete$laborType_f <- factor(mena_jobs_complete$laborType, levels = c("tech_aspros", "off_mgr_pros","service_shop", "clerks", "ag_othlowsk"))
unique(mena_jobs_complete$laborType)

  
#Mena jobs aggre
mena_jobs_aggre_complete<-mena_jobs_complete%>%
  filter(reg %nin% exclu_countries)%>%
  group_by(invested, variable, laborType)%>%
  summarise(mean_mena= mean(value))

mena_jobs_aggre_complete$laborType_f <- factor(mena_jobs_aggre_complete$laborType, levels = c("tech_aspros", "off_mgr_pros", "service_shop", "clerks", "ag_othlowsk"))

#ow skill (ag/unskilled and clerk); medium skill (managerand service) and high skill as Tech/Professional is appropriate.

mena_jobs_aggre_complete$prof_category<-ifelse(mena_jobs_aggre_complete$laborType == "clerks" |  mena_jobs_aggre_complete$laborType== "ag_othlowsk", "Low skilled",
                                 ifelse(mena_jobs_aggre_complete$laborType == "off_mgr_pros" | mena_jobs_aggre_complete$laborType== "service_shop", "Medium skilled", 
                                 ifelse(mena_jobs_aggre_complete$laborType == "tech_aspros", "High skilled", "none")))

mena_jobs_aggre_complete$prof_category_f<-factor(mena_jobs_aggre_complete$prof_category, levels = c("High skilled", "Medium skilled", "Low skilled"))


mena_jobs_aggre_complete%>%
filter(variable == 'total')%>%   
ggplot(aes(fill=laborType_f, y=mean_mena*10, x=reorder(invested, -mean_mena), color = prof_category_f)) +
  geom_bar(position="stack", stat="identity", alpha=.75)+
  labs(
  x = "",
  y = "Total job multiplier (Direct + Indirect)",
  title = "MENA: Job Multiplier by skill",
  subtitle= "By 10 million USD invested in each sector",
  caption = "High skilled refers to Professionals and Technicians. Medium skilled refers to Senior  Official and Managers (dark blue) \n and service and shop workers (light blue). Low skilled refers to Clerks (dark green) and agricultural workers (light green)",
  color="")+
  theme_classic()+
  theme_graph1(legend.position="bottom")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values = c("coral", "steelblue3", "steelblue1", "springgreen3", "springgreen1"),
                    name="")+
  guides(fill=FALSE)+
  scale_color_manual(values = c("coral", "steelblue2","springgreen3"))

ggsave(paste(dir_out, "Jobs_type_skill_all.png"), height=6, width = 8, units = c("in"))

```
#Type of skill (WEIGHTED)
```{r}
#Mena jobs aggre

mena_wjobs_aggre<-left_join(mena_jobs, GDP, by="reg")
  
mena_wjobs_aggre<-mena_wjobs_aggre%>%
  filter(reg %nin% exclu_countries)%>%
  group_by(invested, variable, laborType)%>%
  summarise(wmean_mena= weighted.mean(value, GDP))

mena_wjobs_aggre$laborType_f <- factor(mena_wjobs_aggre$laborType, levels = c("tech_aspros",  "off_mgr_pros",  "service_shop","clerks", "ag_othlowsk"))

mena_wjobs_aggre$prof_category<-ifelse(mena_wjobs_aggre$laborType == "clerks" |  mena_wjobs_aggre$laborType== "ag_othlowsk", "Low skilled",
                                 ifelse(mena_wjobs_aggre$laborType == "off_mgr_pros" | mena_wjobs_aggre$laborType== "service_shop", "Medium skilled", 
                                 ifelse(mena_wjobs_aggre$laborType == "tech_aspros", "High skilled", "none")))

mena_wjobs_aggre$prof_category_f<-factor(mena_wjobs_aggre$prof_category, levels = c("High skilled", "Medium skilled", "Low skilled"))

#GET AGGREGATE VALUES
mena_wjobs_aggre1<- mena_wjobs_aggre%>%
filter(variable == 'total')
mena_wjobs_aggre1<-mena_wjobs_aggre1%>%
  group_by(invested)%>%
  mutate(total_jobs= sum(wmean_mena))

mena_wjobs_aggre1<-mena_wjobs_aggre1%>%
  group_by(invested, laborType)%>%
  mutate(per_jobs= wmean_mena*100/total_jobs)

write.csv(mena_wjobs_aggre1, paste0(dir_out, "MENA_W_Aggre_Skill_share.csv"))

#MENA (reduced)
mena_wjobs_aggre%>%
filter(variable == 'total')%>%   
ggplot(aes(fill=laborType_f, y=wmean_mena*10, x=reorder(invested, -wmean_mena), color=prof_category_f)) +
  geom_bar(position="stack", stat="identity", alpha = .75)+
  labs(
  x = "",
  y = "Total job multiplier (Direct + Indirect)",
  title = "MENA: Job Multiplier by skill",
  subtitle= "By 10 million USD invested in each sector",
  caption = "Weighted mean by GDP (excluding Iraq, Lebanon and Syria). High skilled refers to Professionals and Technicians. \nMedium skilled refers to Senior  Official and Managers (dark blue) and service and shop workers (light blue).\nLow skilled refers to Clerks (dark green) and agricultural workers (light green)",
  color="")+
  theme_classic()+
  theme_graph1(legend.position= "bottom")+
  scale_fill_manual(values = c("coral", "steelblue3", "steelblue1", "springgreen3", "springgreen1"),
                    name="")+
  guides(fill=FALSE)+
  scale_color_manual(values = c("coral", "steelblue2","springgreen3"))

ggsave(paste(dir_out, "WJobs_type_skill_red.png"), height=6, width = 8, units = c("in"))

```





#Type of skills (All countries)
```{r}

mena_jobs_complete$ISO<-toupper(mena_jobs_complete$reg)
mena_jobs_complete$country<-countrycode(mena_jobs_complete$ISO, origin = 'iso3c', destination = 'country.name')

mena_jobs_complete$country[mena_jobs_complete$reg=="Iraq"] <- "Iraq"
mena_jobs_complete$country[mena_jobs_complete$reg=="Syria"] <- "Syria"
mena_jobs_complete$country[mena_jobs_complete$reg=="Lebanon"] <- "Lebanon"


mena_jobs_complete$prof_category<-ifelse(mena_jobs_complete$laborType == "clerks" |  mena_jobs_complete$laborType== "ag_othlowsk", "Low skilled",
                                 ifelse(mena_jobs_complete$laborType == "off_mgr_pros" | mena_jobs_complete$laborType== "service_shop", "Medium skilled", 
                                 ifelse(mena_jobs_complete$laborType == "tech_aspros", "High skilled", "none")))


mena_jobs_complete$prof_category_f<-factor(mena_jobs_complete$prof_category, levels = c("High skilled", "Medium skilled", "Low skilled"))

mena_jobs_complete <- mena_jobs_complete%>%
  select(country, everything())


theme_graph2 <- function(...) {
  theme(
    axis.text.x = element_text(size = 7, angle = 90, hjust = 1, vjust = 0.5),
    legend.text=element_text(size=9),
    axis.text.y = element_text(size = 5),
    axis.title.x= element_text(size = 10),
    plot.subtitle=element_text(hjust=0.5, size = 11, face = "bold"),
    plot.title=element_text(hjust=0.5, size = 12),
    axis.title.y = element_text(size = 9),
    plot.caption=element_text(size=8 ),
    ...
  )
}
```



#MENA (reduced)
mena_wjobs_aggre%>%
filter(variable == 'total')%>%   
ggplot(aes(fill=laborType_f, y=wmean_mena*10, x=reorder(invested, -wmean_mena), color=prof_category_f)) +
  geom_bar(position="stack", stat="identity", alpha = .75)+
  labs(
  x = "",
  y = "Total job multiplier (Direct + Indirect)",
  title = "MENA: Job Multiplier by skill",
  subtitle= "By 10 million USD invested in each sector",
  caption = "Weighted mean by GDP (excluding Iraq, Lebanon and Syria. High skilled refers to Professionals and Technicians. \nMedium skilled refers to Senior  Official and Managers (dark blue) and service and shop workers (light blue).\nLow skilled refers to Clerks (dark green) and agricultural workers (light green)",
  color="")+
  theme_classic()+
  theme_graph1(legend.position= "bottom")+
  scale_fill_manual(values = c("coral", "steelblue3", "steelblue1", "springgreen3", "springgreen1"),
                    name="")+
  guides(fill=FALSE)+
  scale_color_manual(values = c("coral", "steelblue2","springgreen3"))

#Type of jobs by skills (FUNCTION)
```{r}

MENA2<-("mar")

graph_measures<-function(Country_ISO, dir_fig= dir_out_country){

graph_jobs<-mena_jobs_complete %>%
  filter(reg == Country_ISO) 

graph_jobs %>%
filter(variable == 'total')%>%   
ggplot(aes(fill=laborType_f, y=value*10, x=reorder(invested, -value), color=prof_category_f)) +
  geom_bar(position="stack", stat="identity", alpha =.75)+
  labs(
  x = "",
  y = "Total jobs (direct + Indirect)",
  title =  "Job multiplier by skill (10 million USD invested)",
caption= "High skilled refers to Professionals and Technicians. Medium skilled refers to Senior Official and Managers (dark blue) \n and service and shop workers (light blue).Low skilled refers to Clerks (dark green) and agricultural workers (light green)",
  color="",
  subtitle= graph_jobs[1,1])+
  theme_classic()+
  theme_graph2(legend.position="bottom")+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 10))+
  scale_fill_manual(values = c("coral", "steelblue3", "steelblue1", "springgreen3", "springgreen1"),
                    name="")+
  guides(fill=FALSE)+
  scale_color_manual(values = c("coral", "steelblue2","springgreen3"))

ggsave(paste(dir_fig, paste0(Country_ISO, "_job_skill.png"), sep = ""), height=6, width = 8, units = c("in"))

}

#Create for all countries

for (i in MENA) {
  graph_measures(i)
}
```

#jobs and value (all countries) - dotted lines is the median 

```{r}
mena_total_red_median<-mena_total_red%>%
  select(reg, invested, variable, total_jobs, total_gross, total_value, output_shr, valueAdded_shr, labor_shr)

mena_total_red_median<-mena_total_red_median%>%
  group_by(invested, variable)%>%
     mutate(across(where(is.numeric), 
                    .fns = list(med = ~median(.,na.rm = T)),
                    .names = "{fn}_{col}"))


mena_total_red_median$ISO<-toupper(mena_total_red_median$reg)
mena_total_red_median$country<-countrycode(mena_total_red_median$ISO, origin = 'iso3c', destination = 'country.name')
mena_total_red_median<- mena_total_red_median%>%
  select(country, everything())


graph_value_job<-function(Country_ISO, dir_fig= dir_out_country, dataset=mena_total_red_median){

graph_value<-dataset%>%
  filter(reg == Country_ISO) 

graph_value%>% 
  filter(variable == 'total')%>%  
ggplot(aes(x =total_value*10, y =total_jobs*10)) +
  geom_hline(aes(yintercept = median(total_jobs*10)), linetype="dashed", 
                color = "magenta3", size=.5)+
  geom_vline(aes(xintercept = median(total_value*10)), linetype="dashed", 
                color = "magenta3", size=.5)+
  # geom_hline(aes(yintercept = mean(med_total_jobs*10)), linetype="dashed", 
         #       color = "grey25", size=.5)+
  #geom_vline(aes(xintercept = mean(med_total_value*10)), linetype="dashed", 
             #   color = "grey25", size=.5)+
  geom_point(aes(size = valueAdded_shr), color = "springgreen3", alpha=0.7)+
    scale_color_viridis(discrete=TRUE) +
    theme_grey() +
  theme_graph()+
  labs(
  size= "Value Added (%)",
  x = "Value Added Multiplier",
  y = "Total Jobs (direct + indirect)",
  title = "Total Job and Value Added Multipliers",
  subtitle=  graph_value[1,1],
  caption = "Note: By 10 million USD invested in any given sector. Dotted lines in purple represent the country median")+
  geom_text_repel(aes(label=invested), hjust=.9, vjust= .25, size=3)
    
ggsave(paste(dir_fig, paste0(Country_ISO, "_job_value.png"), sep = ""), height=6, width = 8, units = c("in"))

}    

for (i in MENA) {
  graph_value_job(i)
}


```

```{r}
z <- c(2,3,5,3,1,15,23)
median(z)
MeanAD(z, center=median)
```



#Jobs and value (all countries )
```{r}
mena_total_red$ISO<-toupper(mena_total_red$reg)
mena_total_red$country<-countrycode(mena_total_red$ISO, origin = 'iso3c', destination = 'country.name')
mena_total_red <- mena_total_red%>%
  select(country, everything())

mena_total_redmean_jobs
graph_value_job<-function(Country_ISO, dir_fig= dir_out_country, dataset=mena_total_red){

graph_value<-dataset%>%
  filter(reg == Country_ISO) 

graph_value%>% 
  filter(variable == 'total')%>%  
ggplot(aes(x =total_value*10, y =total_jobs*10)) +
  geom_hline(aes(yintercept = mean(total_jobs*10)), linetype="dashed", 
                color = "magenta3", size=.5)+
  geom_vline(aes(xintercept = mean(total_value*10)), linetype="dashed", 
                color = "magenta3", size=.5)+
   geom_hline(aes(yintercept = mean(mean_jobs*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_vline(aes(xintercept = mean(mean_value*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_point(aes(size = valueAdded_shr), color = "springgreen3", alpha=0.7)+
    scale_color_viridis(discrete=TRUE) +
    theme_grey() +
  theme_graph()+
  labs(
  size= "Value Added (%)",
  x = "Value Added Multiplier",
  y = "Total Jobs (direct + indirect)",
  title = "Total Job and Value Added Multipliers",
  subtitle=  graph_value[1,1],
  caption = "Note: By 10 million USD invested in each sector. Dotted lines in purple represent the \n average of the country, dotted lines in grey represents the average of the MENA region")+
  geom_text_repel(aes(label=invested), hjust=.9, vjust= .25, size=3)
    
ggsave(paste(dir_fig, paste0(Country_ISO, "_job_value.png"), sep = ""), height=6, width = 8, units = c("in"))

}    

for (i in MENA) {
  graph_value_job(i)
}


#For Lebanon/Iraq/Syria

ils<- c("Iraq", "Syria", "Lebanon")


graph_value_ils_job<-function(Country_ISO, dir_fig= dir_out_country, dataset=mena_total){

graph_value<-dataset%>%
  filter(reg == Country_ISO) 

graph_value%>% 
  filter(variable == 'total')%>%  
ggplot(aes(x =total_value*10, y =total_jobs*10)) +
  geom_hline(aes(yintercept = mean(total_jobs*10)), linetype="dashed", 
                color = "magenta3", size=.5)+
  geom_vline(aes(xintercept = mean(total_value*10)), linetype="dashed", 
                color = "magenta3", size=.5)+
  # geom_hline(aes(yintercept = mean(mean_jobs*10)), linetype="dashed", 
  #              color = "grey25", size=.5)+
  #geom_vline(aes(xintercept = mean(mean_value*10)), linetype="dashed", 
   #             color = "grey25", size=.5)+
  geom_point(aes(size = valueAdded_shr), color = "springgreen3", alpha=0.7)+
    scale_color_viridis(discrete=TRUE) +
    theme_grey() +
  theme_graph()+
  labs(
  size= "Value Added (%)",
  x = "Value Added Multiplier",
  y = "Total Jobs (direct + indirect)",
  title = "Total Job and Value Added Multipliers",
  subtitle=  graph_value[1,1],
  caption = "Note: By 10 million USD invested in each sector.\n Dotted lines in purple represent the average of the country.")+
  geom_text_repel(aes(label=invested), hjust=.9, vjust= .25, size=3)
    
ggsave(paste(dir_fig, paste0(Country_ISO, "_job_value.png"), sep = ""), height=6, width = 8, units = c("in"))

}    

  
for (i in ils) {
  graph_value_ils_job(i, dataset=mena_total)
}

```



#Weighted mean
```{r}
mena_w_total_red$ISO<-toupper(mena_w_total_red$reg)
mena_w_total_red$country<-countrycode(mena_w_total_red$ISO, origin = 'iso3c', destination = 'country.name')
mena_w_total_red <- mena_w_total_red%>%
  select(country, everything())


graph_value_wjob<-function(Country_ISO, dir_fig= dir_out_country, dataset=mena_w_total_red){

graph_value<-dataset%>%
  filter(reg == Country_ISO) 

graph_value%>% 
  filter(variable == 'total')%>%  
ggplot(aes(x =total_value*10, y =total_jobs*10)) +
  geom_hline(aes(yintercept = mean(total_jobs*10)), linetype="dashed", 
                color = "magenta3", size=.5)+
  geom_vline(aes(xintercept = mean(total_value*10)), linetype="dashed", 
                color = "magenta3", size=.5)+
   geom_hline(aes(yintercept = mean(wmean_jobs*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_vline(aes(xintercept = mean(wmean_value*10)), linetype="dashed", 
                color = "grey25", size=.5)+
  geom_point(aes(size = valueAdded_shr), color = "springgreen3", alpha=0.7)+
    scale_color_viridis(discrete=TRUE) +
    theme_grey() +
  theme_graph()+
  labs(
  size= "Value Added (%)",
  x = "Value Added Multiplier",
  y = "Total Jobs (direct + indirect)",
  title = "Total Job and Value Added Multipliers",
  subtitle=  graph_value[1,1],
  caption = "Note: By 10  million USD invested in each sector. Dotted lines in purple represent the \n average of the country, dotted lines in grey represents the average of the MENA region")+
  geom_text_repel(aes(label=invested), hjust=.9, vjust= .25, size=3)
    
ggsave(paste(dir_fig, paste0(Country_ISO, "W_job_value.png"), sep = ""), height=6, width = 8, units = c("in"))

}    

for (i in MENA) {
  graph_value_wjob(i)
}


```


#Value added Indirect multiplier (all countries MENA)
```{r}

mena_value$ISO<-toupper(mena_value$reg)
mena_value$country<-countrycode(mena_value$ISO, origin = 'iso3c', destination = 'country.name')
mena_value <- mena_value%>%
  select(country, everything())


graph_value_multi<-function(Country_ISO, dir_fig= dir_out_country, dataset = mena_value){

graph_multi<-dataset%>%
  filter(reg == Country_ISO)

graph_multi %>%
filter(invested %in% sd_sec)%>%
  filter_(~ind!=invested)%>%
ggplot( aes(x = reorder(ind, -value), y =value*10, fill= invested)) +
  geom_bar(position="stack", stat="identity", alpha = .85)+
  #geom_line(size=1)+
  theme_grey()+
  theme_graph2()+
    labs(
  fill = "Sector invested",
  x = "",
  y = " Value-added multiplier",
  title = "Indirect Value-Added Multiplier (10 million USD invested)",
  subtitle= graph_multi[1,1],
  caption = "")+
scale_fill_manual(values = c("Food"="orchid", "Fishing"="skyblue", "Forestry"="forestgreen", "GrainsCrops"="chartreuse3", "Lvstk"="coral", "Water"= "steelblue2"),
                    name="")

ggsave(paste(dir_fig, paste0(Country_ISO, "_indirect_value_sd.png"), sep = ""), height=6, width = 8, units = c("in"))

}

for (i in MENA) {
  graph_value_multi(i)
}

#Value added Indirect multiplier (ils)

ils_value <- ils_value%>%
  select(reg, everything())


for (i in ils) {
  graph_value_multi(i, dataset = ils_value)
}

```


#Indirect value multiplier MENA
```{r}
mena_value_agg<-mena_value%>%
  filter(reg %in% MENA_red)
  
mena_value_agg<-left_join(mena_value_agg, GDP, by="reg")

mena_value_agg<-mena_value_agg%>%
  group_by(invested, ind)%>%
  summarise(mean_value= mean(value), mean_w_value= weighted.mean(value, GDP))

#In average which is the sector with more multiplers
mena_value_agg1<-mena_value_agg%>%
  filter_(~ind!=invested)%>%
  group_by(invested)%>%
  mutate(total_mean_multi= mean(mean_w_value))

write.csv(mena_value_agg, paste0(dir_out, "MENA_Value_IndirectMulti.csv"))

brown_sec<-c("CoalOilGas", "OthExtract", "HeavyMnfc")

mena_value_agg = mena_value_agg %>% mutate(sector=ifelse(invested %in% sd_sec,"SD Sector", 
                                                ifelse(invested %in% brown_sec,"Brown Sector", "No defined")))
mena_value_agg$sector = factor(mena_value_agg$sector, levels = c("SD Sector", "Brown Sector"))

mena_value_agg %>%
  filter_(~ind!=invested)%>%
  filter(invested %in% sd_sec | invested %in% brown_sec)%>%
  ggplot( aes(x = reorder(ind, -mean_w_value), y =mean_w_value*10, group= invested, colour=invested)) +
  geom_line(aes(linetype=sector), size=1)+
  geom_point()+
  theme_grey()+
  theme_graph1()+
    labs(
  x = "",
  y = "Value-added multiplier",
  title = "MENA: Indirect Value-Added Multiplier ",
  subtitle= "10 million USD invested",
  caption = "Weighted mean by GDP. MENA region excluding Iraq, Lebanon and Syria, \n due to a different sectoral agreggation in Other Services and Public Administration"
 )

ggsave(paste(dir_out, "WMENA__indirect_value_compare.png"), height=6, width = 8, units = c("in"))

mena_value_agg %>%
  filter_(~ind!=invested)%>%
  filter(invested %in% sd_sec)%>%
  ggplot( aes(x = reorder(ind, -mean_w_value), y =mean_w_value*10, group= invested, colour=invested)) +
  geom_line(size=1)+
  geom_point()+
  theme_grey()+
  theme_graph1()+
    labs(
  x = "",
  y = "Value-added multiplier",
  title = "MENA: Indirect Value-Added Multiplier ",
  subtitle= "10 million USD invested",
  caption = "Weighted mean by GDP. MENA region excluding Iraq, Lebanon and Syria, \n due to a different sectoral agreggation in Other Services and Public Administration"
 )

ggsave(paste(dir_out, "WMENA_indirect_value_sd.png"), height=6, width = 8, units = c("in"))

```




```{r}

mena_total$ISO<-toupper(mena_total$reg)
mena_total$country<-countrycode(mena_total$ISO, origin = 'iso3c', destination = 'country.name')

graph_dir_ind_jobs<-function(Country_ISO, dir_fig= dir_out_country, dataset = mena_total){

graph_total_jobs<-dataset%>%
  filter(reg == Country_ISO)

graph_total_jobs<- graph_total_jobs%>%
  select(country, everything())

graph_total_jobs%>%
    filter(variable!="total")%>%
ggplot(aes(x = reorder(invested, - total_jobs), y = total_jobs*10)) + 
    geom_bar(aes(fill = variable),stat = "identity",position = "stack", alpha=.9)+
  labs(
  y = "Job Multiplier (# Jobs)",
  x = "",
  title = "Job multiplier by 10 million USD invested in each sector",
  subtitle= graph_multi[1,1])+
  theme_graph1()+
  scale_fill_manual(values = brewer.pal(3,"Set2"),
                   name="",
                   labels=c("Direct", "Indirect"))

ggsave(paste(dir_fig, paste0(Country_ISO, "_ind_direct_jobs.png"), sep = ""), height=6, width = 8, units = c("in"))

}


for (i in MENA) {
  graph_dir_ind_jobs(i)
}

for (i in ils) {
  graph_dir_ind_jobs(i)
}

```


```{r}

Forest_land<- WDI(country = c("ARE", "EGY", "IRN", "JOR", "KWT", "OMN", "QAT", "SAU", "TUN", "MAR", "LBN", "IRQ", "SYR"), indicator = "AG.LND.FRST.ZS", start = 1990, end = 2020, extra = TRUE, cache = NULL)
Forest_land <- na.omit(Forest_land)
Forest_land <- Forest_land %>% group_by(iso2c) %>%
  filter(year==max(year))
Forest_land<- subset(Forest_land, select = -c(iso2c,capital,longitude,latitude,lending, region, income))
colnames(Forest_land)<-c("country", "Forest cover%", "year_forest", "iso3c")

Forest_gdp<- WDI(country = c("ARE", "EGY", "IRN", "JOR", "KWT", "OMN", "QAT", "SAU", "TUN", "MAR", "LBN", "IRQ", "SYR"), indicator = "NY.GDP.FRST.RT.ZS", start = 1990, end = 2020, extra = TRUE, cache = NULL)
Forest_gdp <- na.omit(Forest_gdp)
Forest_gdp <- Forest_gdp %>% group_by(iso2c) %>%
  filter(year==max(year))
Forest_gdp<- subset(Forest_gdp, select = -c(iso2c,capital,longitude,latitude,lending, region, income, country))
colnames(Forest_gdp)<-c("Forest GDP%", "year_forest_gdp", "iso3c")

Forest_land<-left_join(Forest_land, Forest_gdp, by="iso3c")
Forest_land<-Forest_land%>%
  select("iso3c", "country", "year_forest", "Forest cover%", "year_forest_gdp", "Forest GDP%")

write.csv(Forest_land, paste0(dir_out, "Forest_data_MENA.csv"))
```

