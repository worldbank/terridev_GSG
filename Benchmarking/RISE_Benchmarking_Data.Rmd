---
title: "Database for international benchmarking"
author: "Giuseppe Rossitti & Evelyn Sanchez"
date: "02/15/2020"
output: html_document

---

```{r setup, include=FALSE}
#knitr::opts_knit$set(root.dir = "C:/Users/####/OneDrive/")
#knitr::opts_knit$set(root.dir = "/Users/eves/Dropbox/MENA/Data/Benchmarking2/")
```

# Required libraries
```{r}
library(WDI)
library(plyr)
library(dplyr)
library(readxl)
library(rvest)
library(tidyverse)
library(countrycode)
library(stringr)
```

# Set Directories
Create the following set of folders 
 dir_raw = store all the csv and excel files that cannot be download through web scraping
 dir_int = This folder is the outcome folder for the global results, name it as "Integrated data" to be consistent with the mapping script "Benchmarking_Graphs"
 
```{r}
dir_raw<-"./Raw_Indicators/"
dir_int<- "./Integrated_data/"
getwd()
```

# Get WDI DATA
```{r}
### WDI INDICATORS ###

#List of WDI indicators used
ind<-c('EN.POP.SLUM.UR.ZS', 'SL.TLF.CACT.FE.ZS', 'SH.STA.SMSS.ZS', 'SH.H2O.SMDW.ZS', 'HD.HCI.OVRL', 'SI.POV.GINI', 'SE.SEC.ENRR', 'SH.IMM.IDPT', 'account.t.d.7', 'NY.ADJ.SVNG.GN.ZS', 'EN.ATM.PM25.MC.M3', 'EG.FEC.RNEW.ZS', 'ER.H2O.INTR.PC', 'EN.ATM.GHGT.KT.CE', 'NY.GNP.MKTP.CD', 'EN.ATM.CO2E.PC', 'EN.ATM.CO2E.PP.GD', 'EG.ELC.ACCS.ZS' , 'SH.STA.TRAF.P5', 'NY.GDP.PCAP.KD.ZG' , 'FP.CPI.TOTL.ZG' , 'SL.UEM.TOTL.ZS' , 'SI.POV.NAHC', 'SG.GEN.PARL.ZS' , 'FX.OWN.TOTL.FE.ZS' , 'per_si_allsi.cov_pop_tot','SE.ADT.LITR.FE.ZS','SH.UHC.SRVS.CV.XD','SH.STA.AIRP.P5','SH.STA.WASH.P5','IT.CEL.SETS.P2','IT.NET.USER.ZS','SH.MED.PHYS.ZS','IS.SHP.GCNW.XQ', 'EN.CLC.SPEI.XD', 'NY.GDP.MKTP.CD', 'SH.STA.MMRT')


#Group indicator by year of data (number after ind- refers to the year used)
ind_12<-c('NY.GDP.MKTP.CD', 'EN.ATM.GHGT.KT.CE')
ind_14<-c('EN.POP.SLUM.UR.ZS')
ind_16 <- c('SH.STA.AIRP.P5','SH.STA.WASH.P5','EN.ATM.CO2E.PC','EN.ATM.CO2E.PP.GD')
ind_17<-c('SH.STA.SMSS.ZS', 'SH.H2O.SMDW.ZS', 'HD.HCI.OVRL','EN.ATM.PM25.MC.M3', 'NY.ADJ.SVNG.GN.ZS','SH.UHC.SRVS.CV.XD', 'ER.H2O.INTR.PC', 'SH.STA.MMRT') 
ind_18<-c('SH.IMM.IDPT', 'SL.TLF.CACT.FE.ZS', 'EG.ELC.ACCS.ZS')
ind_19<-c('IT.CEL.SETS.P2','IT.NET.USER.ZS','IS.SHP.GCNW.XQ')

#Most recent year available between 2015 and 2019
ind_15_19<-c('SI.POV.GINI', 'SE.SEC.ENRR', 'SE.ADT.LITR.FE.ZS')

ind_13_18<-c('SH.STA.TRAF.P5', 'SI.POV.NAHC', 'FX.OWN.TOTL.FE.ZS')



# Importation and cleaning of each WDI indicator
for(i in ind){
  print(i)
   if (i == 'SH.STA.ACSN'){
  wdi <- WDI(country = "all", indicator = i, start = 2010, end = 2015, extra = TRUE, cache = NULL)
  wdi <- na.omit(wdi)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==max(year))
  wdi <- subset(wdi, select = -c(iso2c,capital,longitude, income, region,  year, latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
   }
   if (i == 'per_si_allsi.cov_pop_tot'){
  wdi <- WDI(country = "all", indicator = i, start = 2007, end = 2012, extra = TRUE, cache = NULL)
  wdi <- na.omit(wdi)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==max(year))
  wdi <- subset(wdi, select = -c(iso2c,capital,longitude, income, region,  year, latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
   }
   if (i == 'SH.MED.PHYS.ZS'){
  wdi <- WDI(country = "all", indicator = i, start = 2014, end = 2017, extra = TRUE, cache = NULL)
  wdi <- na.omit(wdi)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==max(year))
  wdi <- subset(wdi, select = -c(iso2c,capital,longitude, income, region,  year, latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
  if (i == 'account.t.d.7'){
  wdi <- WDI(country = "all", indicator = i, start =2000, end =2020, extra = TRUE, cache = NULL)
  wdi<-subset(wdi, !is.na(account.t.d.7))
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==2017)
  wdi <- subset(wdi, select = -c(iso3c, region, income,year,region, capital,longitude,latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso2c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
    if (i %in% ind_13_18){
  wdi <- WDI(country = "all", indicator = i, start = 2013, end = 2018, extra = TRUE, cache = NULL)
  wdi <- na.omit(wdi)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==max(year))
  wdi <- subset(wdi, select = -c(iso2c,capital,longitude, income, region,  year, latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
  if (i %in% ind_15_19){
  wdi <- WDI(country = "all", indicator = i, start = 2015, end = 2019, extra = TRUE, cache = NULL)
  wdi <- na.omit(wdi)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==max(year))
  wdi <- subset(wdi, select = -c(iso2c,capital,longitude, income, region,  year, latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
  if (i %in% ind_12){
  wdi <- WDI(country = "all", indicator = i, start =2000, end =2020, extra = TRUE, cache = NULL)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==2012)
  wdi <- na.omit(wdi)
  wdi <- subset(wdi, select = -c(iso2c,capital,year, income, region, longitude,latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
  if (i %in% ind_14){
  wdi <- WDI(country = "all", indicator = i, start =2000, end =2020, extra = TRUE, cache = NULL)
  wdi <- na.omit(wdi)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==2014)
  wdi <- subset(wdi, select = -c(iso2c,capital,longitude,year,region, income,latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
  if (i == 'EG.FEC.RNEW.ZS'){
  wdi <- WDI(country = "all", indicator = i, start =2000, end =2020, extra = TRUE, cache = NULL)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==2015)
  wdi <- na.omit(wdi)
  wdi <- subset(wdi, select = -c(iso2c,capital,longitude,year, region, latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
  if (i %in% ind_16){
  wdi <- WDI(country = "all", indicator = i, start =2000, end =2020, extra = TRUE, cache = NULL)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==2016)
  wdi <- na.omit(wdi)
  wdi <- subset(wdi, select = -c(iso2c,capital,longitude,year, region, latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
  if (i %in% ind_17){
  wdi <- WDI(country = "all", indicator = i, start =2000, end =2020, extra = TRUE, cache = NULL)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year== 2017)
  wdi <- na.omit(wdi)
  wdi <- subset(wdi, select = -c(iso2c,capital,longitude,year, income, latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
  if (i %in% ind_18){
  wdi <- WDI(country = "all", indicator = i, start =2000, end =2020, extra = TRUE, cache = NULL)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==2018)
  wdi <- na.omit(wdi)
  wdi <- subset(wdi, select = -c(iso2c,capital,longitude,year, income,region, latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
  if (i %in% ind_19){
  wdi <- WDI(country = "all", indicator = i, start =2000, end =2019, extra = TRUE, cache = NULL)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==2019)
  wdi <- subset(wdi, select = -c(iso2c, region, income,year,region, capital,longitude,latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
  if (i == 'SG.GEN.PARL.ZS'){
  wdi <- WDI(country = "all", indicator = i, start =2000, end =2020, extra = TRUE, cache = NULL)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==2020)
  wdi <- subset(wdi, select = -c(iso2c, region, income,year,region, capital,longitude,latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
   }
  if (i == 'EN.CLC.SPEI.XD'){
  wdi <- WDI(country = "all", indicator = i, start =2000, end =2050, extra = TRUE, cache = NULL)
  wdi <- wdi %>% group_by(iso2c) %>% filter(year==2050)
  wdi <- subset(wdi, select = -c(iso2c, region, income,year,region, capital,longitude,latitude,lending,country))
  colnames(wdi)[colnames(wdi)=="iso3c"] <- "iso3"
  assign(paste('wdi_',i,sep=''),wdi)
  }
}


#Youth Not in employment education or training 2013-2017
you_neet <- WDI(country = "all", indicator = 'SL.UEM.NEET.ZS', start =2013, end =2017, extra = TRUE, cache = NULL)
you_neet<- you_neet%>%
  group_by(iso3c)%>%
  dplyr::summarize(mean(SL.UEM.NEET.ZS, na.rm = TRUE))
  colnames(you_neet)<-c("iso3", "you_neet_1317")  


# % Change in energy intensity, 2010-2015 (consistent with GHG change)
energ_int <- WDI(country = "all", indicator = 'EG.EGY.PRIM.PP.KD', start =2010, end =2015, extra = TRUE, cache = NULL)
energ_int <- energ_int[!is.na(energ_int$EG.EGY.PRIM.PP.KD),]
energ_int<- energ_int%>%
  arrange(iso2c,year)%>%
  group_by(iso2c)%>%
  mutate(Diff_year = year - lag(year),  # Difference in time (just in case there are gaps)
         Diff_growth = EG.EGY.PRIM.PP.KD - lag(EG.EGY.PRIM.PP.KD), # Difference in route between years
         Rate_percent = (Diff_growth / Diff_year)/EG.EGY.PRIM.PP.KD * 100) # growth rate in percent
energ_int <- energ_int[energ_int$Diff_year>0,]
energ_int<- energ_int%>%
  group_by(iso3c)%>%
  dplyr::summarize(mean(Rate_percent, na.rm = TRUE))
  colnames(energ_int)<-c("iso3", "energ_int_ch")  
  
 #Simple energy intensity  
energ_int_raw <- WDI(country = "all", indicator = 'EG.EGY.PRIM.PP.KD', start =2010, end =2019, extra = TRUE, cache = NULL)
energ_int_raw <- energ_int_raw %>% group_by(iso2c) %>% filter(year==2015) #191 countries for 2015- no PSE- only for 2014
#energ_int_raw <- energ_int_raw %>%  filter(region!='Aggregates')
#energ_int_raw <- energ_int_raw %>%  filter(!is.na(EG.EGY.PRIM.PP.KD))
energ_int_raw <- subset(energ_int_raw, select = -c(iso2c, region, income,year,region, capital,longitude,latitude,lending,country))
  colnames(energ_int_raw)[colnames(energ_int_raw)=="iso3c"] <- "iso3"
  
  
#Poverty Average 2010- 2016 (replacing incorrect 0 value for Lebanon to NaN)
poverty <- WDI(country = "all", indicator = 'SI.POV.DDAY', start =2010, end =2016, extra = TRUE, cache = NULL)
poverty<- poverty%>%
  group_by(iso3c)%>%
  dplyr::summarize(mean(SI.POV.DDAY, na.rm = TRUE))
  colnames(poverty)<-c("iso3", "pov_1016")  
poverty$pov_1016[poverty$iso3 == "LBN"] <- NaN

  

##GDP, inflation and unemployement for MoPED
##GDP growth average 2015-2019
 gdpgr <- WDI(country = "all", indicator = 'NY.GDP.PCAP.KD.ZG', start =2015, end =2019, extra = TRUE, cache = NULL)
gdpgr<- gdpgr%>%
  group_by(iso3c)%>%
  dplyr::summarize(mean(NY.GDP.PCAP.KD.ZG, na.rm = TRUE))
  colnames(gdpgr)<-c("iso3", "gdpgr_1519")
  

##Inflation average 2015-2019
 infl <- WDI(country = "all", indicator = 'FP.CPI.TOTL.ZG', start =2015, end =2019, extra = TRUE, cache = NULL)
infl<- infl%>%
  group_by(iso3c)%>%
  dplyr::summarize(mean(FP.CPI.TOTL.ZG, na.rm = TRUE))
  colnames(infl)<-c("iso3", "infl_1519")  
  
##Unemployment average 2015-2019
 u <- WDI(country = "all", indicator = 'SL.UEM.TOTL.ZS', start =2015, end =2019, extra = TRUE, cache = NULL)
u<- u%>%
  group_by(iso3c)%>%
  dplyr::summarize(mean(SL.UEM.TOTL.ZS, na.rm = TRUE))
  colnames(u)<-c("iso3", "u_1519")    
  
  
#GNI Data (get all data from 2010 to most recent year to later create water efficiency measure)  
#GNI_data <- WDI(country = "all", indicator = 'NY.GNP.MKTP.CD', start =2010, end =2020, extra = TRUE, cache = NULL)
#GNI_data <- na.omit(GNI_data)
#GNI_data <- subset(GNI_data, select = -c(iso2c,capital,longitude,income,region, latitude,lending,country))
#colnames(GNI_data)[colnames(GNI_data)=="iso3c"] <- "iso3"

#GDP DATA
gdp_data <- WDI(country = "all", indicator = 'NY.GDP.MKTP.CD', start =2010, end =2020, extra = TRUE, cache = NULL)
gdp_data <- na.omit(gdp_data)
gdp_data <- subset(gdp_data, select = -c(iso2c,capital,longitude,income,region, latitude,lending,country))
colnames(gdp_data)[colnames(gdp_data)=="iso3c"] <- "iso3"


## Measuring Internally displaced persons, new displacement associated with disasters (number of cases) per 100000 people

displaced <- WDI(country = "all", indicator = 'VC.IDP.NWDS', start =2015, end =2019, extra = TRUE, cache = NULL)
population <- WDI(country = "all", indicator = 'SP.POP.TOTL', start =2015, end =2019, extra = TRUE, cache = NULL)
displaced<-left_join(displaced,population, by=c("year", "iso3c"))
displaced<-displaced%>%mutate(value= 100000*VC.IDP.NWDS/SP.POP.TOTL)
displaced<- displaced%>%
  group_by(iso3c)%>%
  dplyr::summarize(mean(value, na.rm = TRUE))
  colnames(displaced)<-c("iso3", "displaced")  
  
  
## Measuring Patent applications per capita , new displacement associated with disasters (number of cases) per 100000 people - WIPO data taken from WDI

patents <- WDI(country = "all", indicator = 'IP.PAT.RESD', start =2015, end =2019, extra = TRUE, cache = NULL)
patnonres <- WDI(country = "all", indicator = 'IP.PAT.NRES', start =2015, end =2019, extra = TRUE, cache = NULL)
patents<-left_join(patents,patnonres, by=c("year", "iso3c"))
patents<-left_join(patents,population, by=c("year", "iso3c"))
patents<-patents%>%mutate(value= (IP.PAT.RESD+IP.PAT.NRES)*100000/SP.POP.TOTL)
patents<- patents%>%
  group_by(iso3c)%>%
  dplyr::summarize(mean(value, na.rm = TRUE))
  colnames(patents)<-c("iso3", "patents")  

```


# Import indicators by web scraping 
```{r}
#####  WGI #####
#All indicators from Worldwide Governance Indicators
#website: https://info.worldbank.org/governance/wgi/

#Gov effciency
temp <- tempfile()
download.file("http://info.worldbank.org/governance/wgi/Home/downLoadFile?fileName=wgidataset.xlsx", temp, mode="wb")
effect <- read_excel((temp), sheet = "GovernmentEffectiveness", skip = 14)
effect<-  subset(effect, select= c("Code", "Estimate...117"))   #Estimate...117 for 2018  or Estimate...123 for 2019  
colnames(effect)<-c("iso3", "gov_effect")
effect$gov_effect<- as.numeric(as.character(effect$gov_effect))

#Control of corruption
corr <- read_excel((temp), sheet = "ControlofCorruption", skip = 14)
corr <-  subset(corr, select= c("Code", "Estimate...117"))        #Estimate...117 for 2018  or Estimate...123 for 2019

colnames(corr)<-c("iso3", "cont_corr")
corr$cont_corr<- as.numeric(as.character(corr$cont_corr))

#Regulatory Quality
regq <- read_excel((temp), sheet = "RegulatoryQuality", skip = 14)
regq <-  subset(regq, select= c("Code", "Estimate...117"))   #Estimate...117 for 2018  or  Estimate...123 for 2019    
colnames(regq)<-c("iso3", "reg_qua")
regq$reg_qua<- as.numeric(as.character(regq$reg_qua))


#Rule of Law
rlaw <- read_excel((temp), sheet = "RuleofLaw", skip = 14)
rlaw <-  subset(rlaw, select= c("Code", "Estimate...117"))   #Estimate...117 for 2018  or  Estimate...123 for 2019    
colnames(rlaw)<-c("iso3", "rule_law")
rlaw$rule_law<- as.numeric(as.character(rlaw$rule_law))


###### Population using internet  ######

# SDG INDICATORS data website https://dashboards.sdgindex.org/downloads
temp1 <- tempfile()
download.file("https://sdsna.github.io/SDR2020/SDR2020Database.xlsx", temp1, mode="wb")
internet <- read_excel((temp1), sheet = "Raw Trend Data")
internet<-internet%>%
  select(Country, id, Year,sdg9_intuse)%>%
  group_by(Country)%>%
  filter(Year==2017)    #2017 is the most recent year of the data
colnames(internet)[colnames(internet)=="id"] <- "iso3"
internet<-internet%>%ungroup()%>%select(iso3, sdg9_intuse)


#####  Water efficiency from FAO (data website: http://www.fao.org/sustainable-development-goals/indicators/641/en/) ######


temp2 <- tempfile()
download.file("https://sdlc.fao.org/artifactory/fao-sdg-releases/6.4.1/6_4_1_May_2020.xlsx", temp2, mode="wb")
water_efficiency <- read_excel((temp2))
water_efficiency$iso3<-countrycode(water_efficiency$GeoAreaName, origin = 'country.name', destination = 'iso3c')
water_efficiency<-water_efficiency%>%
  group_by(GeoAreaName)%>%
  filter(TimePeriod==2017)%>%
  ungroup()%>%
  select(iso3, Value)
water_efficiency$Value<-as.numeric(as.character(water_efficiency$Value))
colnames(water_efficiency)[colnames(water_efficiency)=="Value"] <- "water_efficiency_FAO"


##### EPI mesures ######
# data website: https://epi.yale.edu/downloads
# Variables: Biodiverity and Habitat,Wastewater that receives treatment, Fisheries index and Greenhouse gas intensity growth rate) 
temp3 <- tempfile()
download.file("https://epi.yale.edu/downloads/epi2020results20200604.csv", temp3, mode="wb")
epi_indices<-read.csv(temp3)
# 0 in these indicators means no data, so replace 0 with NA
epi_indices<-epi_indices%>%
  select(iso, WWT.new,  BHV.new, FSH.new, GIB.new )%>% 
  mutate_if(is.numeric, ~replace(., . == 0, NA))
colnames(epi_indices)[colnames(epi_indices)=="iso"] <- "iso3"
epi_indices$WWT.new[epi_indices$iso3 == "LBN"] <- NA


###### Fragile State Index #######
#data website:  https://fragilestatesindex.org/excel/
temp4 <- tempfile()
download.file("https://fragilestatesindex.org/wp-content/uploads/2020/05/fsi-2020.xlsx", temp4, mode="wb")
frag_index <- read_excel((temp4))
frag_index$iso3<-countrycode(frag_index$Country, origin = 'country.name', destination = 'iso3c')
frag_index<-frag_index%>%select("iso3","C1: Security Apparatus", "S2: Refugees and IDPs")
colnames(frag_index)<-c("iso3", "sec_aparat", "ref_idp" )


###### Women, Business and  Law ###
# data website: https://wbl.worldbank.org/en/wbl-data
temp5 <- tempfile()
download.file("http://pubdocs.worldbank.org/en/625831591105047863/WBL-50YearPanelDetails-Web-01Jun2020.xlsx", temp5, mode="wb")
women <- read_excel(temp5, sheet = "WBL2020", skip= 1)
#Correct country code for West Bank and Gaza
women$Code[women$Economy=="West Bank and Gaza"] <- "PSE"
women<-  subset(women, select= c("Code", "WBL INDEX"))
colnames(women)<-c("iso3", "wbl")


#For MoPED SMEs owned by women %, there are Option 1 and 2, using Option 1: At least 50 percent female ownership, OR Sole Proprietorships that are female-owned, OR female participation in ownership and management (top manager).

temp6 <- tempfile()
download.file("https://finances.worldbank.org/api/views/ijmu-5v4p/rows.csv", temp6, mode="wb")
smes_wom <- read.csv(temp6)
smes_wom$iso3<-countrycode(smes_wom$Country, origin = 'country.name', destination = 'iso3c')
smes_wom<-  subset(smes_wom, select= c("iso3", "X..Female.SME.Option.1"))
colnames(smes_wom)<-c("iso3", "smes_wom")

#World Economic Forum - Global Competitiveness Index - For Morocco Version
temp7 <- tempfile()
download.file("http://www3.weforum.org/docs/GCR2017-2018/GCI_Dataset_2007-2017.xlsx", temp7, mode="wb")
wef <- read_excel((temp7), sheet = "Data", skip = 3)
wef<-wef%>%filter(Edition=="2017-2018")
wef<-wef%>%filter(Series=="Global Competitiveness Index")
wef<-wef%>%filter(Attribute=="Value")
wef<-wef%>%dplyr::select(-c("Placement", "Dataset", "Edition", "GLOBAL ID", "Code GCR", "Series", "Series unindented", "Attribute"))
wef_long <- gather(wef, country, gci, 1:160)
wef_long$gci<-as.numeric(wef_long$gci)
wef_long$iso3<-countrycode(wef_long$country, origin = 'country.name', destination = 'iso3c')
wef_long$country<-NULL
#competitivines<- left_join(wef_long, lpi_aggregated_ranks, by="iso3")
#cor(competitivines$gci, competitivines$lpi_score, use= "complete.obs") #.84 correlation


```

# Import indicators in excel and csv datasets

```{r}
#Read csv
temp <- list.files(path= dir_raw, pattern = "*.csv")
  file_names <- make.names(gsub("*.csv", "", temp))
  list2env(
    lapply(setNames(paste0(dir_raw, temp), file_names),
           read.csv), envir = .GlobalEnv)
#Read excel
temp <- list.files(path= dir_raw, pattern = "*.xlsx|*.xls")
temp<-temp[str_detect(temp, "\\~", negate = T)] #To avoid hidden files 
file_names <- make.names(gsub("*.xlsx|*.xls", "", temp))
  list2env(
    lapply(setNames(paste0(dir_raw, temp), file_names),
           read_excel), envir = .GlobalEnv)
  
### Risk Unbreakable dataset #####
#Dataset coming from the WB report "Unbreakable: Building the Resilience of the Poor in the Face of Natural Disasters https://openknowledge.worldbank.org/handle/10986/25335"
# Dataset provided by Stephane Hallegatte GFDRR- WB
Unbreakable_global$iso3<-countrycode(Unbreakable_global$country, origin = 'country.name', destination = 'iso3c')
risk<-  subset(Unbreakable_global, select= c(iso3, risk, risk_to_assets))
risk$risk_wellbeing<-risk$risk*100
risk$risk_to_assets<-risk$risk_to_assets*100
risk$risk<-NULL
  
### Agricultural value per value added per worker
# FAO dataset http://www.fao.org/faostat/en/#data/OE, selected variable: Agriculture value added per worker 
FAOSTAT_data_10.23.2020$iso3<-countrycode(FAOSTAT_data_10.23.2020$Area, origin = 'country.name', destination = 'iso3c')
agri_value<-  subset(FAOSTAT_data_10.23.2020, select= c("iso3", "Value"))
colnames(agri_value)<-c("iso3", "agri_value")
  
### Land tenure insecurity from https://www.prindex.net/data/
Land_tenure$iso3<-countrycode(Land_tenure$Name, origin = 'country.name', destination = 'iso3c')
Land_tenure<-Land_tenure%>%select(iso3, Tenure.insecurity)

### Waste inadequately managed
#Data from the paper: https://www.iswa.org/fileadmin/user_upload/Calendar_2011_03_AMERICANA/Science-2015-Jambeck-768-71__2_.pdf
#Database provided by: Martin Heger, Environmental-MENA-WB
Jambeck_et_al_data$iso3<-countrycode(Jambeck_et_al_data$Country, origin = 'country.name', destination = 'iso3c')
Jambeck_et_al_data$iso3[Jambeck_et_al_data$Country=="Channel Islands"] <- "CHI"
Jambeck_et_al_data<-Jambeck_et_al_data%>%select("% Inadequately managed waste5", "iso3")
colnames(Jambeck_et_al_data)<-c("waste_missmanaged", "iso3")
Jambeck_et_al_data$waste_managed<-100-Jambeck_et_al_data$waste_missmanaged #Get inverse value
Jambeck_et_al_data$waste_missmanaged<-NULL

### Waste generation rate
#Data from the WB Report: What a Waste 2.0 : A Global Snapshot of Solid Waste Management to 2050  https://openknowledge.worldbank.org/handle/10986/30317
#Data available for download in the internal Worldbank database (What a waste dataset)
muni_waste<-country_level_data_0%>%
  select("iso3c", "total_msw_total_msw_generated_tons_year", "population_population_number_of_people")
#Calculate waste rate per capita,per day in kg -original data in tons
muni_waste<-muni_waste%>%
  mutate(waste_rate = 1000*(total_msw_total_msw_generated_tons_year/population_population_number_of_people)/356)
muni_waste<-muni_waste%>%
  select("iso3c", "waste_rate")
colnames(muni_waste)[colnames(muni_waste)=="iso3c"] <- "iso3"

##### Logistic index 
#Data from from WB Logistic Performance Index https://lpi.worldbank.org/ , file name = Aggregated LPI 2012-2018(download from webpage since there is an error in the file when use web scraping)
lpi_aggregated_ranks$iso3<-countrycode(lpi_aggregated_ranks$Country, origin = 'country.name', destination = 'iso3c')
lpi_aggregated_ranks<-lpi_aggregated_ranks%>%select("LPI Score", "iso3")
colnames(lpi_aggregated_ranks)<-c("lpi_score", "iso3")

##### Confidence in gov from Gallup World Values survey
#Dataset provided by Jason Russ, Chief Economist Office - Sustainable Development 
Confidence_The_Government<-Confidence_The_Government[6:8,]
Confidence_The_Government <- as.data.frame(t(as.matrix(Confidence_The_Government)))
Confidence_The_Government<-Confidence_The_Government[-c(1:2),]
Confidence_The_Government$V2 <-as.numeric(as.character(Confidence_The_Government$V2))
Confidence_The_Government$V3 <-as.numeric(as.character(Confidence_The_Government$V3))
Confidence_The_Government<-Confidence_The_Government%>% mutate(conf_gov = V2 + V3)
Confidence_The_Government$iso3<-countrycode(Confidence_The_Government$V1, origin = 'country.name', destination = 'iso3c')
Confidence_The_Government<-Confidence_The_Government%>% select('iso3', 'conf_gov')

##### Trust people from Gallup World Values survey
#Dataset provided by Jason Russ, Chief Economist Office - Sustainable Development 
Most_people_can_be_trusted<-Most_people_can_be_trusted[6:7,]
Most_people_can_be_trusted <- as.data.frame(t(as.matrix(Most_people_can_be_trusted)))
Most_people_can_be_trusted<-Most_people_can_be_trusted[-c(1:2),]
Most_people_can_be_trusted$iso3<-countrycode(Most_people_can_be_trusted$V1, origin = 'country.name', destination = 'iso3c')
Most_people_can_be_trusted<-Most_people_can_be_trusted%>% select('iso3', 'V2')
colnames(Most_people_can_be_trusted)<-c('iso3', 'trust_ppl')
Most_people_can_be_trusted$trust_ppl<-as.numeric(as.character(Most_people_can_be_trusted$trust_ppl))

#### Agr land productivity $, 2016
#Dataset provided by Jason Russ, Chief Economist Office - Sustainable Development. Calculations by the Chief Economist Office use the Gross Production Value and Total Agricultural Land from FAO. 
FAO.land.productivity$iso3<-countrycode(FAO.land.productivity$Country, origin = 'country.name', destination = 'iso3c')
FAO.land.productivity$iso3[FAO.land.productivity$Country=="Channel Islands"] <- "CHI"
FAO.land.productivity<-FAO.land.productivity%>% select('iso3', '2016')
colnames(FAO.land.productivity)<-c('iso3', 'agri_land')

#Water efficiency (Replication of calculation proposed by the Chief Economist Office)

#Use Total water withdrawal indicator from http://www.fao.org/nr/water/aquastat/data/query/results.html (download data as csv flat file - countries in y axis and values in x axis) - Take most recent year with data since 2010, and used GDP information of the same year. GDP data was already extracted from the WDI

#aqua<-aquastat_water_withdraw_052021
#aqua<-aqua%>% group_by(Area)%>% filter(Year==max(Year))%>% filter(Year>2009)
#aqua$iso3<-countrycode(aqua$Area, origin = 'country.name', destination = 'iso3c')
#colnames(aqua)[colnames(aqua)=="Year"] <- "year"
#Merge with GNI data,previously downloaded from the WDI  
#aqua<-left_join(aqua,GNI_data, by=c("year", "iso3"))
#aqua<-aqua%>%mutate(water_efficiency_ceo= NY.GNP.MKTP.CD/(Value*1000000000))
#aqua<-aqua%>%ungroup()%>%
#  select("iso3", "water_efficiency_ceo") 

### Water efficiency using GDP
aqua_gdp<-aquastat_water_withdraw_052021
aqua_gdp<-aqua_gdp%>% group_by(Area)%>% filter(Year==max(Year))%>% filter(Year>2009)
aqua_gdp$iso3<-countrycode(aqua_gdp$Area, origin = 'country.name', destination = 'iso3c')
colnames(aqua_gdp)[colnames(aqua_gdp)=="Year"] <- "year"

aqua_gdp<-left_join(aqua_gdp,gdp_data, by=c("year", "iso3"))
aqua_gdp<-aqua_gdp%>%mutate(water_efficiency_GDP= NY.GDP.MKTP.CD/(Value*1000000000))
aqua_gdp<-aqua_gdp%>%ungroup()%>%
  select("iso3", "water_efficiency_GDP")

#aqua_compare<-left_join(aqua, aqua_gdp, by= "iso3")
#cor(aqua_compare$water_efficiency_ceo, aqua_compare$water_efficiency_GDP) 


#From SDG indicators selected by the Egyptian MOPED:
# Proportion of total government spending on essential services, education (%) (SD_XPD_ESED) SDG 1.a.2 - using the last year between 2007 and 2010 to include data on Egypt
# Prevalence of hepatitis B surface antigen (HBsAg) (%) (SH_HAP_HBSAG) SDG 3.3.4
# Proportion of women in managerial positions (%) (IC_GEN_MGTL) SDG 5.5.2
gov_spe_edu<-read_excel(paste0(dir_raw, "SDGMOPED.xlsx"), sheet = "Goal1")
gov_spe_edu$iso3<-countrycode(gov_spe_edu$GeoAreaName, origin = 'country.name', destination = 'iso3c')
gov_spe_edu <- gov_spe_edu[gov_spe_edu$TimePeriod<2010,]
gov_spe_edu <- gov_spe_edu[gov_spe_edu$TimePeriod>2006,]
gov_spe_edu$Value<-as.numeric(as.character(gov_spe_edu$Value))
gov_spe_edu <- gov_spe_edu %>% group_by(iso3) %>% dplyr::summarize(mean(Value, na.rm = TRUE))
colnames(gov_spe_edu)<-c("iso3","gov_spe_edu_SDG")


hepat<-read_excel(paste0(dir_raw, "SDGMOPED.xlsx"), sheet = "Goal3")
hepat$iso3<-countrycode(hepat$GeoAreaName, origin = 'country.name', destination = 'iso3c')
hepat<-hepat%>%
  select(iso3, Value)
hepat$Value<-as.numeric(as.character(hepat$Value))
colnames(hepat)[colnames(hepat)=="Value"] <- "hepat_SDG"

wom_manage<-read_excel(paste0(dir_raw, "SDGMOPED.xlsx"), sheet = "Goal5")
wom_manage$iso3<-countrycode(wom_manage$GeoAreaName, origin = 'country.name', destination = 'iso3c')
wom_manage <- wom_manage[wom_manage$TimePeriod>2015,]
wom_manage <- wom_manage %>% group_by(iso3) %>% filter(TimePeriod==max(TimePeriod))
wom_manage<-wom_manage%>%
  select(iso3, Value)
wom_manage$Value<-as.numeric(as.character(wom_manage$Value))
colnames(wom_manage)[colnames(wom_manage)=="Value"] <- "wom_manage_SDG"


#From IMF financial indicators selected by the Egyptian MOPED for Efficiency:
# Taxes as percentage of government revenue
# Public debt as percentage of GDP
# Capital stock to GDP
debt<-read_excel(paste0(dir_raw, "IMF/imfdebt.xls"))
debt$iso3<-countrycode(debt$Country, origin = 'country.name', destination = 'iso3c')
debt<-debt%>%
  select(iso3, "2019")
colnames(debt)[colnames(debt)=="2019"] <- "debt_gdp_IMF"


balance<-read_excel(paste0(dir_raw, "IMF/imfbalance.xls"))
balance$iso3<-countrycode(balance$Country, origin = 'country.name', destination = 'iso3c')
balance$balance_imf<-rowMeans(balance[,2:6], na.rm=TRUE)
balance<-balance%>%
  select(iso3, balance_imf)


rev<-read_excel(paste0(dir_raw, "IMF/imfrev.xls"))
rev$iso3<-countrycode(rev$Country, origin = 'country.name', destination = 'iso3c')
rev$rev_imf<-rowMeans(rev[,2:5], na.rm=TRUE)
rev<-rev%>%
  select(iso3, rev_imf)

tax_rev<-read_excel(paste0(dir_raw, "IMF/imftaxrev.xlsx"), sheet="Tax Revenue in Percent of GDP")
tax_rev$iso3<-countrycode(tax_rev$Country, origin = 'country.name', destination = 'iso3c')
tax_rev$tax_rev_imf<-rowMeans(tax_rev[,9:12], na.rm=TRUE)
tax_rev<-tax_rev%>%
  select(iso3, tax_rev_imf)


capstock<-read_excel(paste0(dir_raw, "IMF/imfcapstock.xlsx"), sheet="Data")
colnames(capstock)[colnames(capstock)=="isocode"] <- "iso3"
cols.num <- c(5:16)
capstock[cols.num] <- sapply(capstock[cols.num],as.numeric)
capstock$capstock_imf <- (capstock$kgov_rppp +  capstock$kpriv_rppp)/capstock$GDP_rppp
capstock<-capstock%>%
  group_by(iso3)%>%
  filter(year==2015) %>%  #2015 is the most recent year of the data
  select(iso3,capstock_imf)


#From ND-GAIN database get the following indicators:
# projected change of deaths from climate change induced diseases (heal_01)
# *Projected change of warm periods (habi_01)
# *Projected change of flood hazard (habi_02)
# *Projected change of sea level rise impacts (infr_02)
# *Food import dependency (food_03)
# *Dependency on imported energy (infr_03)
# *Dependency on external resource for health services (heal_03)
# *Ecological Footprint (ecos_04)
# For all of those I will use averages for the last 5 years (2014-2015)


ndgain <- c("habi_01","habi_02","infr_02","food_03","infr_03","heal_01","heal_03","ecos_04")


for (ii in ndgain){
ndvar<-read.csv(paste0(dir_raw, "NDGAIN/indicators/id_",ii,"/input.csv"))
ndvar$mean<-rowMeans(ndvar[,22:26], na.rm=TRUE)
ndvar<-ndvar%>%
  select(ISO3, mean)
colnames(ndvar)<-c("iso3",paste0(ii,"_NDG"))
assign(paste("NDG_",ii,sep=''),ndvar)
}


#From SDG indicators selected for V2:
# SDG 6.4.2. Water Stress (ER_H2O_STRESS) 
# Proportion of urban population living in slums (%)  EN_LND_SLUM
# Basic access to water and sanitation (SP_ACS_BSRVH2O) (SP_ACS_BSRVSAN)
# Chlorophyll-a deviations, remote sensing (%)  EN_MAR_CHLDEV

dir_rawv2 <- paste0(dir_raw,"indicatorsV2/")

wat_stress<-read_excel(paste0(dir_rawv2, "ER_H2O_STRESS.xlsx"), sheet = "DataWithFootnotes")
wat_stress$iso3<-countrycode(wat_stress$GeoAreaName, origin = 'country.name', destination = 'iso3c')
wat_stress$Value<-as.numeric(as.character(wat_stress$Value))
wat_stress <- wat_stress[!is.nan(wat_stress$Value),]
#wat_stress <- wat_stress[wat_stress$Time_Detail=="2013-2017",]
wat_stress <- wat_stress %>% group_by(iso3) %>% filter(TimePeriod==max(TimePeriod))
wat_stress<-wat_stress%>%
  select(iso3, Value)
colnames(wat_stress)<-c("iso3","wat_stress_SDG")


pop_slums<-read_excel(paste0(dir_rawv2, "EN_LND_SLUM.xlsx"), sheet = "DataWithFootnotes")
pop_slums$iso3<-countrycode(pop_slums$GeoAreaName, origin = 'country.name', destination = 'iso3c')
pop_slums$Value<-as.numeric(as.character(pop_slums$Value))
pop_slums <- pop_slums[pop_slums$TimePeriod>2013,]
pop_slums <- pop_slums %>% group_by(iso3) %>% filter(TimePeriod==max(TimePeriod))
pop_slums<-pop_slums%>%
  select(iso3, Value)
colnames(pop_slums)<-c("iso3","pop_slums_SDG")



acc_water<-read_excel(paste0(dir_rawv2, "SP_ACS_BSRVH2O.xlsx"), sheet = "DataWithFootnotes")
acc_water$iso3<-countrycode(acc_water$GeoAreaName, origin = 'country.name', destination = 'iso3c')
acc_water$Value<-as.numeric(as.character(acc_water$Value))
acc_water <- acc_water[acc_water$Location=="ALLAREA",]
acc_water <- acc_water %>% group_by(iso3) %>% filter(TimePeriod==max(TimePeriod))
acc_water<-acc_water%>%
  select(iso3, Value)
colnames(acc_water)<-c("iso3","acc_water_SDG")


acc_sani<-read_excel(paste0(dir_rawv2, "SP_ACS_BSRVSAN.xlsx"), sheet = "DataWithFootnotes")
acc_sani$iso3<-countrycode(acc_sani$GeoAreaName, origin = 'country.name', destination = 'iso3c')
acc_sani$Value<-as.numeric(as.character(acc_sani$Value))
acc_sani <- acc_sani[acc_sani$Location=="ALLAREA",]
acc_sani <- acc_sani %>% group_by(iso3) %>% filter(TimePeriod==max(TimePeriod))
acc_sani<-acc_sani%>%
  select(iso3, Value)
colnames(acc_sani)<-c("iso3","acc_sani_SDG")


chloroph<-read_excel(paste0(dir_rawv2, "EN_MAR_CHLDEV.xlsx"), sheet = "DataWithFootnotes")
chloroph$iso3<-countrycode(chloroph$GeoAreaName, origin = 'country.name', destination = 'iso3c')
chloroph$Value<-as.numeric(as.character(chloroph$Value))
chloroph <- chloroph[chloroph$TimePeriod>2015,]
chloroph<- chloroph%>%
  group_by(iso3)%>%
  dplyr::summarize(mean(Value, na.rm = TRUE))
colnames(chloroph)<-c("iso3","chloroph_SDG")


## Add rapid transit (km per million) from sum4all data https://www.sum4all.org/gra-tool/country-performance/indicator/760

rapid_trans<-read_excel(paste0(dir_rawv2, "rapidtransit.xlsx"))
rapid_trans$iso3<-countrycode(rapid_trans$Country, origin = 'country.name', destination = 'iso3c')
rapid_trans$Value<-as.numeric(as.character(rapid_trans$Value))
rapid_trans<-rapid_trans%>%
  select(iso3, Value)
colnames(rapid_trans)<-c("iso3","rapid_trans")

#Global hunger index https://www.globalhungerindex.org/ (data is censored at 5)

glob_hunger_index<-read_excel(paste0(dir_rawv2, "globalhungerindex.xlsx"), sheet = "National Scores")
colnames(glob_hunger_index)<-c("Country","2000","2005","x" ,"x2019","xx","yy")
glob_hunger_index$iso3<-countrycode(glob_hunger_index$Country, origin = 'country.name', destination = 'iso3c')
glob_hunger_index$x2019 <- str_remove(glob_hunger_index$x2019,"<")
glob_hunger_index$Value<-as.numeric(as.character(glob_hunger_index$x2019))
glob_hunger_index<-glob_hunger_index%>%
  select(iso3, Value)
colnames(glob_hunger_index)<-c("iso3","glob_hunger_index")


## Deaths from conflict and terrorism for 100000 peoplehttp://ghdx.healthdata.org/gbd-results-tool, downloaded from Ourworldindata 

terror<-read.csv(paste0(dir_rawv2, "deaths-conflict-terrorism-per-100000.csv"))
terror <- terror[terror$Year>2006,]
colnames(terror)[4]<-"terror"
terror<- terror%>%
  group_by(Code)%>%
  dplyr::summarize(mean(terror, na.rm = TRUE))
colnames(terror)<-c("iso3","terror")

## FAO Aquastat water withdrawals Total water withdrawal per capita m³ per person per year directly dowload from FAO Aquastata - Last update May, 2021 - Last year available is 2017

fao_withdraw<-read.csv(paste0(dir_raw, "water_withdrawal_per_cap_FAO_2017.csv"))
fao_withdraw<-fao_withdraw%>%dplyr::select(Area, Value)
fao_withdraw$iso3<-countrycode(fao_withdraw$Area, origin = 'country.name', destination = 'iso3c')
fao_withdraw<-fao_withdraw%>%dplyr::select(iso3, Value)
colnames(fao_withdraw)<-c("iso3","fao_withdraw_pc")

####  Indicators provided by the Chief Economist Office - Sustainable Development) ####

#SD GG Diagnostics excel file was provided by Jason Russ, Chief Economist Office - Sustainable Development,  which contains  processed/collected data by the Chief Economist Office the from the following sources:

#LGBT Acceptance - Manually collected from the following PDF, appendix 2 (page 31)  https://williamsinstitute.law.ucla.edu/wp-content/uploads/Global-Acceptance-Index-LGBT-Oct-2019.pdf

#Rainfall shock exposure %
#The source of rainfall shock exposure data is author calculations based on GPW population data and Willmott and Matsuura (2001) weather data, it is estimated based on the average share of the population exposed to a dry rainfall shock (rainfall <1 SD below average) over a 5 year period (2009-2013). 

##Pop affected by disasters %
#Collected data from EMDAT database of all instances of disasters marked as Geophysical, Meteorological, Hydrological, and Climatological. Then for each year, it was estimated the number of people killed or affected by it, and the total damages.

#Water quality
#Data from the WB report: Quality Unknown: The Invisible Water Crisis https://www.worldbank.org/en/news/feature/2019/08/20/quality-unknown. Data not yet available for public release

#Rainfall exposure
#Data from the WB report: Charting a New Path for Water's Future (https://www.worldbank.org/en/news/feature/2017/10/24/uncharted-waters). Data not yet available for public release 

#Forest loss%, 2001-2019
#Data from the Global Forest Watch site https://www.globalforestwatch.org/ #For this indicator, tree cover data in 2020 was collected, later annual tree cover loss from 2001 to 2019 was calculated and divided it by the 2020 tree cover to get the forest loss %.

#Food security index, 2019
#Data from the https://foodsecurityindex.eiu.com/, cleaned and proceessed by the CEO
  
  
#Rural access index, 2020
#The Rural Access Index (RAI) measures the proportion of the rural population who live within 2 km of an all-season road. It is included in the Sustainable Development Goals as indicator 9.1.1., providing a way of measuring progress towards Goal 9 and Target 9.1. 

  
#Change in GHG emissions per capita 2008-2017
#Percentage change of GHG emissions per capita from 2008 to 2017, CAIT Climate Data Explorer via. Climate Watch
  
#Population exposure from epidemics (% of total pop exposed) 
#The average share of population affected epidemiological disasters over a 20 year period (2000-2019). EM-DAT database
#Note: The variable was upwardly censored at 0.045% to prevent extreme outliers from biasing the benchmarking


#Digital penetration index
#It is also called digital adoption index. The DAI is a worldwide index that measures countries’ digital adoption across three dimensions of the economy: people, government, and business. The index covers 180 countries on a 0–1 scale and emphasizes the “supply-side” of digital adoption to maximize coverage and simplify theoretical linkages.


ceo_data<-read_excel(paste0(dir_raw, "SD GG Diagnostic - Database V10.xlsx"), sheet = "Master2")
ceo_data <-  subset(ceo_data, select= c("Country Name",  "LGBT acceptance index", "Water quality", "Food security index", "Forest loss%, short-term (2001-2019)", "*Pop affected %", "*Rainfall exp %", "Rural access %","*GHG per capita %change","*Epidemic %","Digital adoption"))
colnames(ceo_data)<-c("Country",  "LGBT_acc", "wat_qua", "food_sec", "forest_loss", "pop_dis", "rain_exp","rai","ghg_pc","pop_epid","dai")
ceo_data$iso3<-countrycode(ceo_data$Country, origin = 'country.name', destination = 'iso3c')

#Multiply by 100 percentage variables
ceo_data$pop_dis<-ceo_data$pop_dis*100
ceo_data$rain_exp<-ceo_data$rain_exp*100
ceo_data$forest_loss<-ceo_data$forest_loss*100
ceo_data$pop_epid<-ceo_data$pop_epid*100000


#Correct Kosovo and Channel Islands
ceo_data$iso3[ceo_data$Country=="Kosovo"] <- "XKX"
ceo_data$iso3[ceo_data$Country=="Channel Islands"] <- "CHI"
ceo_data$Country<-NULL

```

# List of countries with their updated income classification and regional group
Some countries had changed income category and WDI hasn't update correctly, so better use the most current country classification (June 2020), available at https://datahelpdesk.worldbank.org/knowledgebase/articles/906519-world-bank-country-and-lending-group
```{r}
#Download country income classification
temp6 <- tempfile()
download.file("http://databank.worldbank.org/data/download/site-content/CLASS.xls", temp6, mode="wb")
income_class <- read_excel(temp6, sheet = 1, skip= 4)%>%
  filter(!is.na(`Income group`))%>%
  filter(`Income group` != "x")%>%
  select("Economy",  "Code", "Region", "Income group")

colnames(income_class)<-c("country", "iso3", "region", "income") 
```

# Merge all datasets
```{r}
#Join all indicators (income classification at the beginning, to have countries information first)
ind2 <- list(income_class, wdi_EG.ELC.ACCS.ZS, wdi_EG.FEC.RNEW.ZS, wdi_SH.STA.TRAF.P5, wdi_SI.POV.NAHC, wdi_SG.GEN.PARL.ZS, wdi_FX.OWN.TOTL.FE.ZS, wdi_EN.ATM.CO2E.PP.GD ,wdi_EN.POP.SLUM.UR.ZS, wdi_SL.TLF.CACT.FE.ZS, wdi_SH.STA.SMSS.ZS, wdi_SH.H2O.SMDW.ZS, wdi_HD.HCI.OVRL, wdi_SI.POV.GINI, wdi_SE.SEC.ENRR, wdi_SH.IMM.IDPT, wdi_account.t.d.7, wdi_NY.ADJ.SVNG.GN.ZS, wdi_EN.ATM.PM25.MC.M3, wdi_SE.ADT.LITR.FE.ZS, wdi_ER.H2O.INTR.PC, wdi_NY.GDP.MKTP.CD, wdi_EN.ATM.GHGT.KT.CE, wdi_EN.ATM.CO2E.PC, wdi_per_si_allsi.cov_pop_tot, gdpgr, u, infl, poverty, effect, corr, regq, internet, water_efficiency, epi_indices, frag_index, women, risk, agri_value, Land_tenure, Jambeck_et_al_data, muni_waste, lpi_aggregated_ranks, Confidence_The_Government, Most_people_can_be_trusted, FAO.land.productivity, ceo_data, gov_spe_edu, hepat, wom_manage, capstock, debt, rev, tax_rev, balance, pop_slums, displaced, wat_stress, glob_hunger_index, terror, NDG_ecos_04, NDG_food_03, NDG_habi_01, NDG_habi_02,  NDG_infr_02, NDG_heal_03, NDG_infr_03, NDG_heal_01, wdi_SH.UHC.SRVS.CV.XD, acc_sani, acc_water, wdi_SH.STA.AIRP.P5, wdi_SH.STA.WASH.P5, fao_withdraw, chloroph, rlaw, wdi_IT.CEL.SETS.P2, wdi_IT.NET.USER.ZS, rapid_trans, energ_int, wdi_SH.MED.PHYS.ZS, you_neet , smes_wom,patents,wdi_IS.SHP.GCNW.XQ, 
energ_int_raw, wef_long, aqua_gdp, wdi_SH.STA.MMRT
             #, aqua
             )

#library(plyr)
integrated <- plyr::join_all(ind2, type = "left", match = "first") 
integrated <- integrated %>% select(country, everything())

###Create GDP/GHG ######
#NY.GDP.MKTP.CD/ EN.ATM.GHGT.KT.CE
integrated$gdp_ghg<-integrated$NY.GDP.MKTP.CD/integrated$EN.ATM.GHGT.KT.CE

###Taxes as % of Revenues by diving Tax as % of GDP by Revenue as % of GDP ######
#NY.GNP.MKTP.CD/ EN.ATM.GHGT.KT.CE
integrated$taxrev_imf<-integrated$tax_rev_imf/integrated$rev_imf


#Save database with all countries in the world
write.csv(integrated, paste0(dir_int, "Integrated_v5.csv"), row.names = FALSE)

```



```{r}

integrated<-read.csv(paste0(dir_int, "Integrated_v5.csv"))

#The Chief Economist Office selected a list of 167 countries for the benchmarking exercise, base on tests on how some countries values could modify the estimation of regional and world scores.
#From the overall database,  here we filter the list of countries selected by the Chief Economist Office
list_countries<-ceo_data$iso3  
integrated2<-integrated%>%
  filter(iso3 %in% list_countries)

#Clean working space
rm(list=setdiff(ls(), c("dir_int", "dir_raw", "integrated", "integrated2", "ceo_data", "list_countries")))
```

# Create indicators list
Divide indicators in two lists: Two-sided higher value represents good performance or Inverse case: higher value represents bad performance 
We name the indicators only before producing the graphs, otherwise names get corrupted when exporting to csv
Also copy the db to a different db to be used for group by group percentiles

```{r}
#Two-sided case: Higher value is better performance, but indicator can take on negative values
#colnames(integrated2)
two_side<-c('country', "iso3", "region", "income",  "food_sec", "SL.TLF.CACT.FE.ZS","SH.H2O.SMDW.ZS", "SH.H2O.SMDW.ZS", "SH.STA.SMSS.ZS", "HD.HCI.OVRL", "SE.SEC.ENRR", "SH.IMM.IDPT", "account.t.d.7", "LGBT_acc", "wbl", "conf_gov", "trust_ppl", "NY.ADJ.SVNG.GN.ZS", "EG.FEC.RNEW.ZS", "ER.H2O.INTR.PC", "wat_qua",  "agri_value", "agri_land", "gdp_ghg", "cont_corr", "gov_effect", "reg_qua", "lpi_score", "WWT.new", "waste_managed", "BHV.new", "FSH.new", "sdg9_intuse", "water_efficiency_FAO", "water_efficiency_GDP", "GIB.new", "EG.ELC.ACCS.ZS", "FX.OWN.TOTL.FE.ZS", "gdpgr_1519", "SG.GEN.PARL.ZS", "per_si_allsi.cov_pop_tot", "SE.ADT.LITR.FE.ZS", "wom_manage_SDG", "gov_spe_edu_SDG", "balance_imf", "taxrev_imf", "SH.MED.PHYS.ZS", "SH.UHC.SRVS.CV.XD", "acc_sani_SDG", "acc_water_SDG", "rai", "rule_law", "IT.CEL.SETS.P2", "IT.NET.USER.ZS", "rapid_trans","smes_wom","patents","IS.SHP.GCNW.XQ","dai", "gci")

#Inverse case: Higher value is worse performance, (no negative)
inv_side<- c('country', "iso3", "region", "income", "risk_to_assets", "risk_wellbeing", "pop_dis",  "rain_exp", "EN.POP.SLUM.UR.ZS", "pov_1016", "SI.POV.GINI", "EN.ATM.PM25.MC.M3", "forest_loss", "ref_idp", "sec_aparat", "waste_rate",  "EN.ATM.CO2E.PC", "Tenure.insecurity", "u_1519", "infl_1519", "SH.STA.TRAF.P5", "SI.POV.NAHC", "EN.ATM.CO2E.PP.GD", "hepat_SDG", "debt_gdp_IMF", "capstock_imf", "displaced", "wat_stress_SDG", "glob_hunger_index", "terror", "pop_slums_SDG", "heal_01_NDG", "habi_01_NDG", "habi_02_NDG", "infr_02_NDG", "food_03_NDG", "infr_03_NDG", "heal_03_NDG", "SH.STA.AIRP.P5","SH.STA.WASH.P5","fao_withdraw_pc", "ecos_04_NDG", "chloroph_SDG","energ_int_ch","you_neet_1317","ghg_pc","pop_epid", 'EG.EGY.PRIM.PP.KD', 'SH.STA.MMRT') 


integrated3 <- integrated2

```



#Calculate Percentile Rank
Calculates country percentile value comparing all countries in the dataset
```{r}
#inverse per ranking function
per_inv <- function(x) {
  y = (1- percent_rank(x))
}

#Get percentile for two sided variables (higher value-better performance)
vars_nor<-two_side[-(1:4)]
vars_nor <- setNames(vars_nor, paste0(vars_nor, "_per")) # create new column names
integrated2 <- integrated2 %>% 
  mutate_each_(funs(percent_rank), vars_nor)

#Get percentile for inverse variables (higher value- worse performance)
vars_inv<-inv_side[-(1:4)]
vars_inv <- setNames(vars_inv, paste0(vars_inv, "_per")) # create new column names
integrated2 <- integrated2 %>% 
  mutate_each_(funs(per_inv), vars_inv)

```
# Save all the database with raw values and percentile data (worldwide data)
```{r}
write.csv(integrated2, paste0(dir_int, "World_SD_values_V5.csv"), row.names = FALSE)
```


# Calculate Scores per Income group (Income group calculation)

I changed this to compute the percentile score in the same way as above but by groups, the old way of computing scores is still in the code but commented out

```{r}
options(scipen=999)


per_inv <- function(x) {
  y = (1- percent_rank(x))
}


scores_inc <- integrated3

#Get percentile for two sided variables (higher value-better performance)
vars_nor<-two_side[-(1:4)]
vars_nor <- setNames(vars_nor, paste0(vars_nor, "_per")) # create new column names
scores_inc <- scores_inc %>% 
  group_by(income) %>% 
  mutate_each_(funs(percent_rank), vars_nor)

#Get percentile for inverse variables (higher value- worse performance)
vars_inv<-inv_side[-(1:4)]
vars_inv <- setNames(vars_inv, paste0(vars_inv, "_per")) # create new column names
scores_inc <- scores_inc %>% 
    group_by(income) %>% 
  mutate_each_(funs(per_inv), vars_inv)

scores_inc <- scores_inc[-(5:109)]
colnames(scores_inc) <- str_replace(colnames(scores_inc),"_per","") 

scores_reg <- integrated3

#Get percentile for two sided variables (higher value-better performance)
vars_nor<-two_side[-(1:4)]
vars_nor <- setNames(vars_nor, paste0(vars_nor, "_per")) # create new column names
scores_reg <- scores_reg %>% 
  group_by(region) %>% 
  mutate_each_(funs(percent_rank), vars_nor)



#Get percentile for inverse variables (higher value- worse performance)
vars_inv<-inv_side[-(1:4)]
vars_inv <- setNames(vars_inv, paste0(vars_inv, "_per")) # create new column names
scores_reg <- scores_reg %>% 
    group_by(region) %>% 
  mutate_each_(funs(per_inv), vars_inv)

scores_reg <- scores_reg[-(5:109)]
colnames(scores_reg) <- str_replace(colnames(scores_reg),"_per","") 


## All scores compared to income groups to compute MENA average
write.csv(scores_inc, paste0(dir_int, "DB_SD_all_score.csv"), row.names = FALSE)


#Filter by income group

##LMICS## 
integrated_lmics_score <- scores_inc %>% dplyr::filter(income=='Lower middle income')
# Save 
write.csv(integrated_lmics_score, paste0(dir_int, "DB_SD_lmics_score.csv"), row.names = FALSE)


##UMICS## 
integrated_umics_score <- scores_inc %>% filter(income=='Upper middle income')
# Save 
write.csv(integrated_umics_score, paste0(dir_int, "DB_SD_umics_score.csv"), row.names = FALSE)

#LICS

integrated_lics_score <- scores_inc %>% filter(income=='Low income')
# Save 
write.csv(integrated_lics_score, paste0(dir_int, "DB_SD_lics_score.csv"), row.names = FALSE)

#HICS 

integrated_hics_score <- scores_inc %>% filter(income=="High income")
# Save 
write.csv(integrated_hics_score, paste0(dir_int, "DB_SD_hics_score.csv"), row.names = FALSE)


##MENA## (no used, only calculated for internal use)
integrated_MENA_score <- scores_reg %>% filter(region=='Middle East & North Africa')
# Save 
write.csv(integrated_MENA_score, paste0(dir_int, "DB_SD_MENA_score.csv"), row.names = FALSE)

```










